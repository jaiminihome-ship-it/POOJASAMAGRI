<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Premium Vedic Letterpad - Final Spacing</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Devanagari:wght@400;700&family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root { 
      --bhagwa: #FF6F00; /* Deep Crispy Orange */
      --deep-black: #000000; 
    }
    body { background: #333; font-family: 'Noto Sans Devanagari', sans-serif; margin: 0; }
    
    #capture-zone { background: white; width: 210mm; margin: 20px auto; padding: 40px; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
    
    table { width: 100%; border-collapse: collapse; border: 2.5px solid var(--deep-black); margin-top: 5px; }
    th, td { border: 1.5px solid var(--deep-black); padding: 6px 12px; text-align: left; font-size: 14.2px; color: var(--deep-black); font-weight: 700; }
    th { background: #FFF3E0; color: var(--bhagwa); font-family: 'Noto Serif Devanagari', serif; }

    /* === ‡§≠‡§µ‡•ç‡§Ø ‡§µ‡•à‡§¶‡§ø‡§ï ‡§π‡•á‡§°‡§∞ === */
    .vedic-header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
    .swastik-corner { font-size: 80px; color: var(--bhagwa); line-height: 1; font-weight: bold; }
    .title-center { text-align: center; flex-grow: 1; }
    .main-title-grand { color: var(--bhagwa); font-size: 45px; font-weight: 800; margin: 0; font-family: 'Noto Serif Devanagari', serif; }
    .sub-title-grand { color: var(--deep-black); font-size: 32px; margin: 3px 0; font-weight: 700; font-family: 'Noto Serif Devanagari', serif; }

    /* SIMPLE LINE (Location 1) */
    .simple-divider { border-bottom: 2.5px solid var(--bhagwa); margin: 8px 0 15px 0; }

    /* VEDIC SWASTIKA LINE (Location 2) */
    .swastika-divider-line {
      text-align: center; color: var(--bhagwa); font-size: 20px; 
      margin: 12px 0 8px 0; letter-spacing: 14px; font-weight: bold;
      border-top: 2px solid var(--bhagwa); padding-top: 4px;
    }

    /* ENHANCED INFO GRID */
    .info-grid-enhanced { 
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px; 
      font-weight: 800; color: var(--deep-black); font-size: 21px; 
      padding: 15px; background: #fff8f0; border-radius: 8px; border: 1.8px solid #ffe0b2;
    }
    .info-grid-enhanced b { color: var(--bhagwa); font-family: 'Noto Serif Devanagari', serif; }
    
    /* ‡§´‡•Ç‡§ü‡§∞ ‡§Ö‡§¨ ‡§î‡§∞ ‡§≠‡•Ä ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§¶‡•Ç‡§∞‡•Ä ‡§™‡§∞ */
    .footer { margin-top: 10px; border-top: 4px solid var(--bhagwa); padding-top: 10px; text-align: center; font-size: 14px; font-weight: 700; color: var(--deep-black); }
    
    .actions { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 1000; }
    button { padding: 15px 35px; border-radius: 50px; border: none; font-weight: 700; color: white; cursor: pointer; font-size: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.3s; }
    .btn-pdf { background: linear-gradient(135deg, var(--bhagwa), #e65100); }
    .btn-img { background: linear-gradient(135deg, #2E7D32, #1b5e20); }
    
    #print-temp { position: absolute; left: -9999px; top: 0; width: 210mm; }
  </style>
</head>
<body>

<div id="capture-zone">
  <div id="preview-content"></div>
</div>

<div id="print-temp"></div>

<div class="actions">
  <button class="btn-pdf" onclick="generatePaginatedPDF()">üìÑ Download PDF</button>
  <button class="btn-img" onclick="saveAsMultiImages()">üñºÔ∏è Download Images</button>
</div>

<script>
  const meta = JSON.parse(localStorage.getItem("pooja_meta") || "{}");
  const items = JSON.parse(localStorage.getItem("final_samagri") || "[]");
  const pList = JSON.parse(localStorage.getItem("selected_poojas") || "[]");

  let itemPairs = [];
  for(let i=0; i<items.length; i+=2) {
    itemPairs.push([items[i], items[i+1]]);
  }

  const pName = meta.pandit?.name || "---";
  let footerStr = `‡§™‡§Ç‡§°‡§ø‡§§: ${pName} | ‡§´‡•ã‡§®: ${meta.pandit?.phone || ""} | ‡§™‡§§‡§æ: ${meta.pandit?.address || ""}`;
  if(pName.includes("Yugal")) footerStr += ` | ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü: astroyugalacharya.in`;
  const footerHtml = `<div class="footer">${footerStr}</div>`;

  function renderTable(pairs) {
    let rows = pairs.map(p => `<tr>
      <td>${p[0]?.name||""}</td><td>${p[0] ? p[0].qty+' '+p[0].unit : ""}</td>
      <td>${p[1]?.name||""}</td><td>${p[1] ? p[1].qty+' '+p[1].unit : ""}</td>
    </tr>`).join('');
    return `<table><thead><tr><th>‡§∏‡§æ‡§Æ‡§æ‡§®</th><th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th><th>‡§∏‡§æ‡§Æ‡§æ‡§®</th><th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th></tr></thead><tbody>${rows}</tbody></table>`;
  }

  const grandVedicHeader = `
    <div class="vedic-header-container">
      <div class="swastik-corner">Âçê</div>
      <div class="title-center">
        <h1 class="main-title-grand">‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É ‡••</h1>
        <h2 class="sub-title-grand">‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</h2>
      </div>
      <div class="swastik-corner">Âçê</div>
    </div>
    <div class="simple-divider"></div>
    <div class="info-grid-enhanced">
        <div><b>‡§Ø‡§ú‡§Æ‡§æ‡§®:</b> ${meta.yajman}</div><div><b>‡§§‡§æ‡§∞‡•Ä‡§ñ:</b> ${meta.date}</div>
        <div><b>‡§™‡§Ç‡§°‡§ø‡§§:</b> ${pName}</div><div><b>‡§™‡•Ç‡§ú‡§æ:</b> ${pList.join(", ")}</div>
    </div>
    <div class="swastika-divider-line">Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê</div>
  `;

  document.getElementById("preview-content").innerHTML = grandVedicHeader + renderTable(itemPairs) + footerHtml;

  function generatePageHTML(pageNum, chunk) {
      // ‡§™‡•á‡§ú 2+ ‡§™‡§∞ ‡§Æ‡§æ‡§∞‡•ç‡§ú‡§ø‡§® 10mm ‡§∞‡§ñ‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à
      let headerContent = (pageNum === 1) ? grandVedicHeader : `<div style="height:10mm;"></div>`;
      return `<div style="padding:40px; background:white; position:relative; min-height:297mm; border:15px solid #FF6F00; box-sizing:border-box;">
                ${headerContent}
                ${renderTable(chunk)}
                <div style="position:absolute; bottom:25px; left:40px; right:40px;">${footerHtml}</div>
              </div>`;
  }

  async function generatePaginatedPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const printTemp = document.getElementById("print-temp");
    let totalPairs = itemPairs.length;
    let processed = 0, pageNum = 1;

    while (processed < totalPairs) {
      if (pageNum > 1) pdf.addPage();
      // ‡§™‡§π‡§≤‡•á ‡§™‡§®‡•ç‡§®‡•á ‡§™‡§∞ ‡§≤‡§ø‡§Æ‡§ø‡§ü ‡§Ö‡§¨ 18 ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§´‡•Ç‡§ü‡§∞ ‡§î‡§∞ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§∞‡§æ ‡§ó‡•à‡§™ ‡§∞‡§π‡•á
      let limit = (pageNum === 1) ? 18 : 28;
      let chunk = itemPairs.slice(processed, processed + limit);
      printTemp.innerHTML = generatePageHTML(pageNum, chunk);
      const canvas = await html2canvas(printTemp, { scale: 3.5, useCORS: true });
      pdf.addImage(canvas.toDataURL("image/jpeg", 1.0), 'JPEG', 0, 0, 210, 297);
      processed += limit;
      pageNum++;
    }
    pdf.save("${meta.yajman || 'Pooja'}_Fixed_Grand_List.pdf");
    printTemp.innerHTML = "";
  }

  async function saveAsMultiImages() {
    const printTemp = document.getElementById("print-temp");
    let totalPairs = itemPairs.length;
    let processed = 0, pageNum = 1;
    const baseName = meta.yajman || 'Pooja';

    while (processed < totalPairs) {
      // ‡§™‡§π‡§≤‡•á ‡§™‡§®‡•ç‡§®‡•á ‡§™‡§∞ 18, ‡§¨‡§æ‡§ï‡•Ä ‡§™‡§∞ 28
      let limit = (pageNum === 1) ? 18 : 28;
      let chunk = itemPairs.slice(processed, processed + limit);
      printTemp.innerHTML = generatePageHTML(pageNum, chunk);
      const canvas = await html2canvas(printTemp, { scale: 3.5, useCORS: true });
      const link = document.createElement("a");
      link.download = `${baseName}_Page_${pageNum}.png`;
      link.href = canvas.toDataURL("image/png");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      await new Promise(resolve => setTimeout(resolve, 300));
      processed += limit;
      pageNum++;
    }
    printTemp.innerHTML = "";
  }
</script>
</body>
</html>