<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Premium Vedic Letterpad - Complete Fix</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Devanagari:wght@400;700&family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root { 
      --bhagwa: #FF6F00; 
      --deep-black: #000000; 
    }
    body { background: #333; font-family: 'Noto Sans Devanagari', sans-serif; margin: 0; }
    
    #capture-zone { background: white; width: 210mm; margin: 20px auto; padding: 40px; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
    
    table { width: 100%; border-collapse: collapse; border: 2.5px solid var(--deep-black); margin-top: 5px; }
    th, td { border: 1.5px solid var(--deep-black); padding: 6px 12px; text-align: left; font-size: 14.2px; color: var(--deep-black); font-weight: 700; }
    th { background: #FFF3E0; color: var(--bhagwa); font-family: 'Noto Serif Devanagari', serif; }

    .vedic-header-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
    .swastik-corner { font-size: 80px; color: var(--bhagwa); line-height: 1; font-weight: bold; }
    .title-center { text-align: center; flex-grow: 1; }
    .main-title-grand { color: var(--bhagwa); font-size: 45px; font-weight: 800; margin: 0; font-family: 'Noto Serif Devanagari', serif; }
    .sub-title-grand { color: var(--deep-black); font-size: 32px; margin: 3px 0; font-weight: 700; font-family: 'Noto Serif Devanagari', serif; }

    .simple-divider { border-bottom: 2.5px solid var(--bhagwa); margin: 8px 0 15px 0; }
    .swastika-divider-line { text-align: center; color: var(--bhagwa); font-size: 20px; margin: 12px 0 8px 0; letter-spacing: 14px; font-weight: bold; border-top: 2px solid var(--bhagwa); padding-top: 4px; }

    .editable-field { 
      border: none; border-bottom: 2px dotted var(--bhagwa); 
      font-size: 19px; font-weight: 800; color: var(--deep-black); 
      background: transparent; width: 90%; outline: none;
      font-family: 'Noto Sans Devanagari', sans-serif;
    }

    .info-grid-enhanced { 
      display: grid; grid-template-columns: 1.2fr 1fr; gap: 8px 15px; 
      font-weight: 800; color: var(--deep-black); font-size: 19px; 
      padding: 15px; background: #fff8f0; border-radius: 8px; border: 1.8px solid #ffe0b2;
    }
    .info-grid-enhanced b { color: var(--bhagwa); font-family: 'Noto Serif Devanagari', serif; }
    .full-width-info { grid-column: span 2; }
    
    .footer { margin-top: 10px; border-top: 4px solid var(--bhagwa); padding-top: 10px; text-align: center; font-size: 14px; font-weight: 700; color: var(--deep-black); }
    
    .actions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; z-index: 1000; width: 95%; }
    button { padding: 12px 20px; border-radius: 50px; border: none; font-weight: 700; color: white; cursor: pointer; font-size: 14px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: 0.3s; }
    .btn-pdf { background: linear-gradient(135deg, var(--bhagwa), #e65100); }
    .btn-img { background: linear-gradient(135deg, #2E7D32, #1b5e20); }
    .btn-share { background: linear-gradient(135deg, #007bff, #0056b3); } /* Share Button Color */
    
    #print-temp { position: absolute; left: -9999px; top: 0; width: 210mm; }
  </style>
</head>
<body>

<div id="capture-zone">
  <div id="preview-content"></div>
</div>

<div id="print-temp"></div>

<div class="actions">
  <button class="btn-pdf" onclick="generatePaginatedPDF()">üìÑ PDF Download</button>
  <button class="btn-img" onclick="saveAsMultiImages()">üñºÔ∏è Image Download</button>
  <button class="btn-share" onclick="shareAsPDF()">üì§ WhatsApp Share</button>
</div>

<script>
  const meta = JSON.parse(localStorage.getItem("pooja_meta") || "{}");
  const items = JSON.parse(localStorage.getItem("final_samagri") || "[]");
  const pList = JSON.parse(localStorage.getItem("selected_poojas") || "[]");

  let itemPairs = [];
  for(let i=0; i<items.length; i+=2) {
    itemPairs.push([items[i], items[i+1]]);
  }

  const pName = meta.pandit?.name || "---";
  const pPhone = meta.pandit?.phone || "---";
  const pAddr = meta.pandit?.address || "---";

  let footerStr = `‡§™‡§Ç‡§°‡§ø‡§§: ${pName} | ‡§´‡•ã‡§®: ${pPhone} | ‡§™‡§§‡§æ: ${pAddr}`;
  if(pName.includes("Yugal")) footerStr += ` | ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü: astroyugalacharya.in`;
  const footerHtml = `<div class="footer">${footerStr}</div>`;

  function renderTable(pairs) {
    let rows = pairs.map(p => `<tr>
      <td>${p[0]?.name||""}</td><td>${p[0] ? p[0].qty+' '+p[0].unit : ""}</td>
      <td>${p[1]?.name||""}</td><td>${p[1] ? p[1].qty+' '+p[1].unit : ""}</td>
    </tr>`).join('');
    return `<table><thead><tr><th>‡§∏‡§æ‡§Æ‡§æ‡§®</th><th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th><th>‡§∏‡§æ‡§Æ‡§æ‡§®</th><th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th></tr></thead><tbody>${rows}</tbody></table>`;
  }

  function getGrandHeader(isStatic = false, currentVals = {}) {
    const yName = isStatic ? currentVals.yajman : `<input type="text" id="yInput" class="editable-field" value="${meta.yajman || ''}">`;
    const yDate = isStatic ? currentVals.date : `<input type="text" id="dInput" class="editable-field" value="${meta.date || ''}">`;
    const poojaField = isStatic ? currentVals.pooja : `<input type="text" id="poojaInput" class="editable-field" value="${pList.join(", ")}">`;

    return `
      <div class="vedic-header-container">
        <div class="swastik-corner">Âçê</div>
        <div class="title-center">
          <h1 class="main-title-grand">‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É ‡••</h1>
          <h2 class="sub-title-grand">‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</h2>
        </div>
        <div class="swastik-corner">Âçê</div>
      </div>
      <div class="simple-divider"></div>
      <div class="info-grid-enhanced">
          <div><b>‡§Ø‡§ú‡§Æ‡§æ‡§®:</b> ${yName}</div><div><b>‡§§‡§æ‡§∞‡•Ä‡§ñ:</b> ${yDate}</div>
          <div><b>‡§™‡§Ç‡§°‡§ø‡§§:</b> ${pName}</div><div><b>‡§´‡•ã‡§®:</b> ${pPhone}</div>
          <div class="full-width-info"><b>‡§™‡•Ç‡§ú‡§æ:</b>&nbsp;${poojaField}</div>
          <div class="full-width-info"><b>‡§™‡§§‡§æ:</b>&nbsp;${pAddr}</div>
      </div>
      <div class="swastika-divider-line">Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê Âçê</div>
    `;
  }

  document.getElementById("preview-content").innerHTML = getGrandHeader() + renderTable(itemPairs) + footerHtml;

  function generatePageHTML(pageNum, chunk, currentVals) {
      let headerContent = (pageNum === 1) ? getGrandHeader(true, currentVals) : `<div style="height:10mm;"></div>`;
      return `<div style="padding:40px; background:white; position:relative; min-height:297mm; border:15px solid #FF6F00; box-sizing:border-box;">
                ${headerContent}
                ${renderTable(chunk)}
                <div style="position:absolute; bottom:25px; left:40px; right:40px;">${footerHtml}</div>
              </div>`;
  }

  // PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡§æ ‡§Æ‡§æ‡§∏‡•ç‡§ü‡§∞ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® (‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§î‡§∞ ‡§∂‡•á‡§Ø‡§∞ ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§æ‡§Æ ‡§Ü‡§è‡§ó‡§æ)
  async function createPDF(currentVals) {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const printTemp = document.getElementById("print-temp");
    let totalPairs = itemPairs.length;
    let processed = 0, pageNum = 1;

    while (processed < totalPairs) {
      if (pageNum > 1) pdf.addPage();
      let limit = (pageNum === 1) ? 15 : 28;
      let chunk = itemPairs.slice(processed, processed + limit);
      printTemp.innerHTML = generatePageHTML(pageNum, chunk, currentVals);
      const canvas = await html2canvas(printTemp, { scale: 3, useCORS: true });
      pdf.addImage(canvas.toDataURL("image/jpeg", 0.9), 'JPEG', 0, 0, 210, 297);
      processed += limit;
      pageNum++;
    }
    printTemp.innerHTML = "";
    return pdf;
  }

  async function generatePaginatedPDF() {
    const currentVals = {
      yajman: document.getElementById("yInput").value,
      date: document.getElementById("dInput").value,
      pooja: document.getElementById("poojaInput").value
    };
    const pdf = await createPDF(currentVals);
    pdf.save(`${currentVals.yajman || 'Pooja'}_Samagri.pdf`);
  }

  // --- WhatsApp Share Fix ---
  async function shareAsPDF() {
    const currentVals = {
      yajman: document.getElementById("yInput").value,
      date: document.getElementById("dInput").value,
      pooja: document.getElementById("poojaInput").value
    };
    
    const pdf = await createPDF(currentVals);
    const pdfBlob = pdf.output('blob');
    const file = new File([pdfBlob], `${currentVals.yajman}_List.pdf`, { type: "application/pdf" });

    if (navigator.share) {
      try {
        await navigator.share({
          files: [file],
          title: '‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä',
          text: `${currentVals.yajman} ‡§ï‡•Ä ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä`
        });
      } catch (err) {
        alert("Share ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤: " + err);
      }
    } else {
      alert("‡§Ü‡§™‡§ï‡•á ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç Direct Share ‡§ï‡•Ä ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ PDF Download ‡§ï‡§∞‡§ï‡•á ‡§≠‡•á‡§ú‡•á‡§Ç‡•§");
    }
  }

  // --- Image Download Fix (Successive Click Logic) ---
  async function saveAsMultiImages() {
    const currentVals = {
      yajman: document.getElementById("yInput").value,
      date: document.getElementById("dInput").value,
      pooja: document.getElementById("poojaInput").value
    };
    const printTemp = document.getElementById("print-temp");
    let totalPairs = itemPairs.length;
    let processed = 0, pageNum = 1;

    while (processed < totalPairs) {
      let limit = (pageNum === 1) ? 15 : 28;
      let chunk = itemPairs.slice(processed, processed + limit);
      printTemp.innerHTML = generatePageHTML(pageNum, chunk, currentVals);
      
      const canvas = await html2canvas(printTemp, { scale: 3, useCORS: true });
      const imgData = canvas.toDataURL("image/png");
      
      // Download link
      const link = document.createElement("a");
      link.href = imgData;
      link.download = `${currentVals.yajman}_Page_${pageNum}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      processed += limit;
      pageNum++;
      // ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§ï‡•ã ‡§∏‡§æ‡§Ç‡§∏ ‡§≤‡•á‡§®‡•á ‡§ï‡§æ ‡§∏‡§Æ‡§Ø ‡§¶‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§∏‡§ø‡§ï‡•ç‡§Ø‡•ã‡§∞‡§ø‡§ü‡•Ä ‡§¨‡•ç‡§≤‡•â‡§ï ‡§® ‡§π‡•ã
      await new Promise(r => setTimeout(r, 800)); 
    }
    printTemp.innerHTML = "";
  }
</script>
</body>
</html>
