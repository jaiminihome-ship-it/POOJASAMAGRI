<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Database Control Pro - Nirpreet</title>
  <style>
    :root { --main: #FF9800; --dark: #2D3436; --red: #d32f2f; }
    body { font-family: system-ui; background: #f0f2f5; margin: 0; padding-bottom: 20px; }
    header { background: var(--dark); color: white; padding: 25px 20px; text-align: center; border-bottom: 5px solid var(--main); }
    .container { padding: 15px; max-width: 500px; margin: auto; }
    .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    h2 { font-size: 18px; margin: 0 0 15px; color: var(--dark); display: flex; align-items: center; gap: 10px; }
    label { font-size: 13px; color: #666; margin-bottom: 5px; display: block; font-weight: 600; }
    input, select, textarea { width: 100%; padding: 14px; border: 1.5px solid #eee; border-radius: 12px; margin-bottom: 15px; box-sizing: border-box; font-size: 15px; font-family: inherit; }
    #newPoojaBox { background: #fff3e0; padding: 15px; border-radius: 12px; border: 1px dashed var(--main); margin-bottom: 15px; display: none; }
    .btn-save { width: 100%; padding: 16px; background: var(--main); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; }
    .list-area { max-height: 450px; overflow-y: auto; border-radius: 12px; background: #fafafa; border: 1px solid #eee; transition: 0.3s; }
    .item-row { padding: 15px; border-bottom: 1.5px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
    .info-box { flex-grow: 1; display: flex; flex-direction: column; gap: 4px; }
    .samagri-name { font-weight: 700; color: var(--dark); font-size: 17px; }
    .badge { background: #E3F2FD; color: #1976D2; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; align-self: flex-start; }
    .delete-btn { background: #fee2e2; color: var(--red); border: none; width: 42px; height: 42px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; transition: 0.3s; }
    .delete-btn:hover { background: var(--red); color: white; }
    
    .flash-refresh { animation: flashEffect 0.5s ease-out; }
    @keyframes flashEffect { 0% { opacity: 0.5; background: #FFF3E0; } 100% { opacity: 1; background: #fafafa; } }
  </style>
</head>
<body>

<header>
  <h1 style="margin:0; font-size:20px;">üóÑÔ∏è ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•à‡§®‡•á‡§ú‡§Æ‡•á‡§Ç‡§ü</h1>
</header>

<div class="container">
  <div class="card">
    <h2>‚ûï ‡§®‡§Ø‡§æ ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h2>
    <label>‡§™‡•Ç‡§ú‡§æ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</label>
    <select id="poojaSelect" onchange="toggleNewPooja()"><option value="">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</option></select>
    <div id="newPoojaBox">
      <label>‡§®‡§Ø‡•Ä ‡§™‡•Ç‡§ú‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
      <input id="newPoojaInput" placeholder="‡§ú‡•à‡§∏‡•á: ‡§∏‡•Å‡§®‡•ç‡§¶‡§∞‡§ï‡§æ‡§£‡•ç‡§°">
    </div>
    <label>‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ (‡§π‡§∞ ‡§≤‡§æ‡§á‡§® ‡§Æ‡•á‡§Ç ‡§è‡§ï ‡§≤‡§ø‡§ñ‡•á‡§Ç)</label>
    <textarea id="samagriInput" placeholder="‡§ú‡•à‡§∏‡•á: ‡§ï‡§≤‡§æ‡§µ‡§æ&#10;‡§®‡§æ‡§∞‡§ø‡§Ø‡§≤&#10;‡§ï‡•Å‡§Æ‡§ï‡•Å‡§Æ" style="height: 100px; resize: vertical;"></textarea>
    <button class="btn-save" id="saveBtn" onclick="addSamagri()">‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
  </div>

  <div class="card">
    <h2>üìã ‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§°‡•á‡§ü‡§æ</h2>
    <select id="filterPooja" onchange="renderList()"><option value="">‡§∏‡§≠‡•Ä ‡§™‡•Ç‡§ú‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç</option></select>
    <div class="list-area" id="dataList">
      <div style="text-align:center; padding:20px; color:#999;">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
    </div>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbyhXVfu7WVAs2pQQLyH3lkkO3ZG-rmbqTmyygjqH8XeWyQPNgqx49whCIsa8WttKRZ4/exec";
  let rawData = [];

  function loadData(isSilent = false) {
    const list = document.getElementById("dataList");
    if(!isSilent) list.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>';
    
    fetch(API_URL).then(r => r.json()).then(data => {
      rawData = data;
      const poojas = [...new Set(data.map(x => x.pooja?.trim()))].filter(Boolean).sort();
      let options = '<option value="">-- ‡§ö‡•Å‡§®‡•á‡§Ç --</option>' + 
                    poojas.map(p => `<option value="${p}">${p}</option>`).join("") +
                    '<option value="ADD_NEW" style="color:var(--main); font-weight:bold;">+ ‡§®‡§Ø‡•Ä ‡§™‡•Ç‡§ú‡§æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</option>';
      document.getElementById("poojaSelect").innerHTML = options;
      document.getElementById("filterPooja").innerHTML = '<option value="">‡§∏‡§≠‡•Ä ‡§™‡•Ç‡§ú‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç</option>' + poojas.map(p => `<option>${p}</option>`).join("");
      
      renderList();
      if(isSilent) {
          list.classList.add('flash-refresh');
          setTimeout(() => list.classList.remove('flash-refresh'), 500);
      }
    });
  }

  function toggleNewPooja() {
    document.getElementById("newPoojaBox").style.display = (document.getElementById("poojaSelect").value === "ADD_NEW") ? "block" : "none";
  }

  function renderList() {
    const filter = document.getElementById("filterPooja").value;
    const list = document.getElementById("dataList");
    list.innerHTML = "";
    rawData.filter(r => !filter || r.pooja === filter).forEach(r => {
      list.innerHTML += `
        <div class="item-row">
          <div class="info-box">
            <span class="samagri-name">${r.samagri}</span>
            <span class="badge">${r.pooja}</span>
          </div>
          <button class="delete-btn" onclick="deleteSamagri('${r.pooja}', '${r.samagri}')" title="‡§°‡§ø‡§≤‡•Ä‡§ü">üóëÔ∏è</button>
        </div>`;
    });
  }

  // === ‡§Ö‡§™‡§°‡•á‡§ü‡•á‡§° 'Bulk Add' ‡§≤‡•â‡§ú‡§ø‡§ï ===
  async function addSamagri() {
    const pSelect = document.getElementById("poojaSelect");
    const npInput = document.getElementById("newPoojaInput");
    const sInput = document.getElementById("samagriInput");
    const sBtn = document.getElementById("saveBtn");

    let pooja = pSelect.value;
    if(pooja === "ADD_NEW") pooja = npInput.value.trim();
    
    const rawText = sInput.value.trim();
    if(!pooja || !rawText) return alert("‡§™‡•Ç‡§ú‡§æ ‡§î‡§∞ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç!");

    const items = rawText.split("\n").map(i => i.trim()).filter(i => i !== "");

    sBtn.innerText = "‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...";
    sBtn.disabled = true;

    try {
      // ‡§π‡§∞ ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§≤‡§ó ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü (Loop)
      for (let item of items) {
        await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({ action: "add", pooja: pooja, samagri: item })
        });
      }

      // ‡§∏‡§´‡§≤‡§§‡§æ ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§∏‡§´‡§æ‡§à
      sInput.value = "";
      npInput.value = "";
      loadData(true); 
      sBtn.innerText = "‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç";
      sBtn.disabled = false;
      sInput.focus();
    } catch(err) {
        alert("‡§ï‡•Å‡§õ ‡§∏‡§æ‡§Æ‡§æ‡§® ‡§∏‡•á‡§µ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ‡§è!");
        sBtn.innerText = "‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç";
        sBtn.disabled = false;
    }
  }

  function deleteSamagri(pooja, samagri) {
    if(!confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ '${samagri}' ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`)) return;
    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify({ action: "deleteItem", pooja, samagri })
    }).then(r => r.json()).then(resp => {
      if(resp.status === "ok") { loadData(true); }
    });
  }

  loadData();
</script>
</body>
</html>
