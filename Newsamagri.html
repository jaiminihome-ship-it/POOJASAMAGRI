<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <meta name="theme-color" content="#FF6F00">
  <title>Vedic Studio Ultra - Complete System</title>
  
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&family=Noto+Serif+Devanagari:wght@400;600;700;900&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #FF6F00;
      --primary-dark: #E65100;
      --primary-light: #FFB74D;
      --secondary: #00BFA5;
      --dark: #1A1A2E;
      --light: #FFFFFF;
      --gray-100: #F5F5F5;
      --gray-300: #E0E0E0;
      --gray-400: #BDBDBD;
      --gray-600: #757575;
      --success: #00C853;
      --error: #FF1744;
      --warning: #FFD600;
      
      --gradient-primary: linear-gradient(135deg, #FF6F00 0%, #FF8F00 100%);
      --gradient-dark: linear-gradient(135deg, #1A1A2E 0%, #16213E 100%);
      
      --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.16);
      
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      
      --transition: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      
      --font-primary: 'Poppins', sans-serif;
      --font-hindi: 'Noto Serif Devanagari', serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-primary);
      background: var(--gradient-dark);
      color: var(--light);
      overflow-x: hidden;
      min-height: 100vh;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 50%, rgba(255, 111, 0, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
      animation: breathe 20s ease-in-out infinite;
    }

    @keyframes breathe {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gradient-primary);
      border-radius: 4px;
    }

    .app-container {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0;
      min-height: 100vh;
    }

    /* Top Nav */
    .top-nav {
      position: sticky;
      top: 0;
      z-index: 1000;
      padding: 1rem;
      margin-bottom: 2rem;
    }

    .nav-glass {
      background: rgba(26, 26, 46, 0.9);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-xl);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 111, 0, 0.2);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .brand-icon {
      width: 48px;
      height: 48px;
      background: var(--gradient-primary);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 4px 12px rgba(255, 111, 0, 0.3);
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .brand-text h1 {
      font-size: 1.25rem;
      font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      line-height: 1.2;
    }

    .brand-text p {
      font-size: 0.75rem;
      color: var(--gray-400);
      margin: 0;
    }

    .nav-actions {
      display: flex;
      gap: 0.5rem;
    }

    .nav-btn {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: var(--light);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      transition: var(--transition);
    }

    .nav-btn:hover {
      background: rgba(255, 111, 0, 0.2);
      transform: translateY(-2px);
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 1rem;
      pointer-events: none;
    }

    .bottom-nav-glass {
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-xl);
      padding: 0.75rem;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 0.5rem;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 111, 0, 0.2);
      max-width: 700px;
      margin: 0 auto;
      pointer-events: all;
    }

    .tab-btn {
      background: transparent;
      border: none;
      color: var(--gray-400);
      cursor: pointer;
      padding: 0.75rem;
      border-radius: var(--radius-md);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      transition: var(--transition);
      font-size: 0.75rem;
      font-weight: 600;
      position: relative;
    }

    .tab-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--gradient-primary);
      opacity: 0;
      transition: var(--transition);
      border-radius: var(--radius-md);
      z-index: -1;
    }

    .tab-btn.active {
      color: white;
    }

    .tab-btn.active::before {
      opacity: 1;
    }

    .tab-icon {
      font-size: 1.5rem;
    }

    /* Main Content */
    .main-content {
      padding: 0 1rem 8rem 1rem;
      position: relative;
    }

    .page-section {
      display: none;
      animation: fadeInUp 0.5s;
    }

    .page-section.active {
      display: block;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section-header {
      margin-bottom: 2rem;
      text-align: center;
    }

    .section-title {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .section-subtitle {
      color: var(--gray-400);
      font-size: 1rem;
    }

    /* Card */
    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: var(--transition);
    }

    .card:hover {
      border-color: rgba(255, 111, 0, 0.3);
      box-shadow: var(--shadow-lg);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Form */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--gray-300);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-md);
      color: white;
      font-family: var(--font-primary);
      font-size: 1rem;
      transition: var(--transition);
      outline: none;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      border-color: var(--primary);
      background: rgba(255, 111, 0, 0.05);
      box-shadow: 0 0 0 4px rgba(255, 111, 0, 0.1);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
      font-family: var(--font-hindi);
    }

    /* Button */
    .btn {
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: var(--radius-md);
      font-family: var(--font-primary);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      box-shadow: 0 4px 12px rgba(255, 111, 0, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 111, 0, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .btn-success {
      background: linear-gradient(135deg, #00C853 0%, #00E676 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #FF1744 0%, #FF5252 100%);
      color: white;
    }

    .btn-block {
      width: 100%;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Pandit Grid */
    .pandit-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .pandit-card {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .pandit-card.selected {
      border-color: var(--primary);
      background: rgba(255, 111, 0, 0.1);
      transform: scale(1.05);
    }

    .pandit-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .pandit-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    .pandit-info h3 {
      font-size: 1.125rem;
      font-weight: 700;
      color: white;
      margin-bottom: 0.25rem;
    }

    .pandit-info p {
      font-size: 0.875rem;
      color: var(--gray-400);
    }

    /* Pooja Grid */
    .pooja-grid {
      display: grid;
      gap: 0.75rem;
    }

    .pooja-item {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-md);
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      transition: var(--transition);
      user-select: none;
    }

    .pooja-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .pooja-item.selected {
      background: rgba(255, 111, 0, 0.1);
      border-color: var(--primary);
    }

    .pooja-checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid var(--gray-400);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      flex-shrink: 0;
    }

    .pooja-item.selected .pooja-checkbox {
      background: var(--gradient-primary);
      border-color: var(--primary);
    }

    .pooja-checkbox::after {
      content: '‚úì';
      color: white;
      font-weight: 700;
      opacity: 0;
      transform: scale(0);
      transition: var(--transition);
    }

    .pooja-item.selected .pooja-checkbox::after {
      opacity: 1;
      transform: scale(1);
    }

    .pooja-content {
      flex: 1;
    }

    .pooja-name {
      font-weight: 600;
      color: white;
    }

    .pooja-count {
      font-size: 0.75rem;
      color: var(--gray-400);
    }

    .pooja-actions {
      display: flex;
      gap: 0.5rem;
    }

    .pooja-action-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .pooja-action-btn:hover {
      background: var(--gradient-primary);
    }

    /* Material */
    .material-section {
      margin-bottom: 2rem;
    }

    .material-header {
      background: rgba(255, 111, 0, 0.1);
      border-left: 4px solid var(--primary);
      padding: 1rem;
      border-radius: var(--radius-md);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .material-title {
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .material-list {
      display: grid;
      gap: 0.5rem;
    }

    .material-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-md);
      padding: 0.75rem;
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 0.75rem;
      align-items: center;
    }

    .material-check {
      width: 20px;
      height: 20px;
      accent-color: var(--primary);
      cursor: pointer;
    }

    .material-name {
      color: white;
      font-weight: 500;
    }

    .material-qty,
    .material-unit {
      padding: 0.5rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      color: white;
    }

    .material-qty {
      width: 80px;
      text-align: center;
    }

    .material-unit {
      width: 100px;
      cursor: pointer;
    }

    /* Template Grid */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }

    .template-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      transition: var(--transition);
    }

    .template-card:hover {
      border-color: var(--primary);
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }

    .template-name {
      font-size: 1.125rem;
      font-weight: 700;
      color: white;
      margin-bottom: 0.5rem;
    }

    .template-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      font-size: 0.875rem;
      color: var(--gray-400);
    }

    .template-actions {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 0.5rem;
    }

    /* Database Table */
    .db-table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .db-table th,
    .db-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .db-table th {
      background: rgba(255, 111, 0, 0.2);
      color: white;
      font-weight: 700;
    }

    .db-table tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .db-actions {
      display: flex;
      gap: 0.5rem;
    }

    .db-btn {
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 0.75rem;
      transition: var(--transition);
    }

    .db-btn-edit {
      background: var(--primary);
      color: white;
    }

    .db-btn-delete {
      background: var(--error);
      color: white;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 400px;
    }

    .toast {
      background: rgba(26, 26, 46, 0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--radius-md);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: var(--shadow-lg);
      border-left: 4px solid var(--primary);
      animation: slideInRight 0.3s;
      min-width: 300px;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .toast-icon {
      font-size: 1.5rem;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      color: white;
      margin-bottom: 0.25rem;
    }

    .toast-message {
      font-size: 0.875rem;
      color: var(--gray-400);
    }

    .toast.success {
      border-left-color: var(--success);
    }

    .toast.error {
      border-left-color: var(--error);
    }

    .toast.warning {
      border-left-color: var(--warning);
    }

    /* Loading */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 1rem;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: white;
      font-weight: 600;
      font-size: 1.125rem;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--dark);
      border-radius: var(--radius-xl);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 111, 0, 0.3);
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    .modal-close {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: var(--transition);
    }

    .modal-close:hover {
      background: var(--error);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      text-align: center;
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      margin: 0 auto 1rem;
      background: var(--gradient-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: white;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--gray-400);
      text-transform: uppercase;
    }

    /* PDF Preview */
    .pdf-preview-container {
      background: #e0e0e0;
      border-radius: var(--radius-lg);
      padding: 2rem;
      max-height: 600px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 2rem;
      align-items: center;
    }

    .pdf-preview-page {
      background: white;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 600px;
      position: relative;
      padding: 30px;
      font-family: 'Noto Serif Devanagari', serif;
    }

    .page-number {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--primary);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    /* Editable Fields */
    .editable {
      border: 2px dashed transparent;
      padding: 2px 4px;
      border-radius: 4px;
      transition: var(--transition);
      cursor: text;
      min-width: 100px;
      display: inline-block;
    }

    .editable:hover {
      border-color: rgba(255, 111, 0, 0.3);
      background: rgba(255, 111, 0, 0.05);
    }

    .editable:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(255, 111, 0, 0.1);
    }

    /* PDF Styles (for generation) */
    .pdf-page {
      position: absolute;
      left: -9999px;
      top: 0;
      width: 210mm;
      background: white;
      padding: 30px;
      box-sizing: border-box;
      font-family: 'Noto Serif Devanagari', serif;
      page-break-after: always;
    }

    .pdf-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #FF6F00;
    }

    .pdf-header h1 {
      color: #FF6F00;
      font-size: 32px;
      margin: 0 0 5px 0;
      font-weight: 700;
    }

    .pdf-header h2 {
      color: #333;
      font-size: 24px;
      margin: 0;
      font-weight: 600;
    }

    .pdf-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      font-size: 14px;
      color: #333;
      margin-bottom: 20px;
    }

    .pdf-details div {
      padding: 3px 0;
    }

    .pdf-details strong {
      color: #FF6F00;
      font-weight: 600;
    }

    .pdf-content {
      min-height: 200mm;
    }

    .pdf-pooja-heading {
      background: #FF6F00;
      color: white;
      padding: 8px 12px;
      margin: 15px 0 10px 0;
      border-radius: 5px;
      font-weight: 600;
      font-size: 16px;
    }

    .pdf-table {
      width: 100%;
      border-collapse: collapse;
      border: 2px solid #333;
      margin-bottom: 15px;
      font-size: 13px;
    }

    .pdf-table th,
    .pdf-table td {
      border: 1px solid #666;
      padding: 8px;
      text-align: left;
      color: #333;
    }

    .pdf-table th {
      background: #f5f5f5;
      color: #FF6F00;
      font-weight: 600;
    }

    .pdf-footer {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 3px solid #FF6F00;
      text-align: center;
      color: #555;
      font-size: 12px;
    }

    .pdf-footer div {
      margin-bottom: 5px;
      font-weight: 500;
    }

    .pdf-footer strong {
      color: #333;
      font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .section-title {
        font-size: 1.5rem;
      }

      .pandit-grid,
      .template-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .bottom-nav-glass {
        grid-template-columns: repeat(3, 1fr);
      }

      .tab-btn:nth-child(n+4) {
        display: none;
      }

      .pdf-preview-container {
        padding: 1rem;
      }

      .pdf-preview-page {
        padding: 15px;
        font-size: 12px;
      }
    }

    /* Utilities */
    .hidden {
      display: none !important;
    }

    .mt-2 { margin-top: 1rem; }
    .mb-2 { margin-bottom: 1rem; }
    .gap-2 { gap: 1rem; }
    .grid { display: grid; }
  </style>
</head>
<body>

  <div class="toast-container" id="toastContainer"></div>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Processing...</div>
  </div>

  <!-- Add Modal -->
  <div class="modal" id="addModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">‚ûï Add to Database</h3>
        <button class="modal-close" onclick="app.closeModal('addModal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Pooja Name</label>
          <input type="text" class="form-input" id="modalPoojaName" placeholder="Enter or select existing pooja">
          <select class="form-select mt-2" id="existingPoojaSelect" onchange="app.selectExistingPooja()">
            <option value="">Or select existing pooja</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Samagri Items (one per line)</label>
          <textarea class="form-textarea" id="modalSamagriItems" placeholder="Enter samagri items, one per line"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="app.closeModal('addModal')">Cancel</button>
        <button class="btn btn-primary" onclick="app.saveToDatabase()">Add to Database</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">‚úèÔ∏è Edit Item</h3>
        <button class="modal-close" onclick="app.closeModal('editModal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Pooja Name</label>
          <input type="text" class="form-input" id="editPoojaName" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">Samagri Name</label>
          <input type="text" class="form-input" id="editSamagriName">
        </div>
        <input type="hidden" id="editRowIndex">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="app.closeModal('editModal')">Cancel</button>
        <button class="btn btn-primary" onclick="app.updateDatabaseItem()">Update</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">‚öôÔ∏è Settings</h3>
        <button class="modal-close" onclick="app.closeModal('settingsModal')">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">First Page Rows</label>
          <input type="number" class="form-input" id="settingFirstPageRows" value="15" min="10" max="25">
        </div>
        <div class="form-group">
          <label class="form-label">Subsequent Page Rows</label>
          <input type="number" class="form-input" id="settingSubsequentPageRows" value="20" min="15" max="30">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="app.closeModal('settingsModal')">Close</button>
        <button class="btn btn-primary" onclick="app.saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>

  <div class="app-container">
    
    <div class="top-nav">
      <div class="nav-glass">
        <div class="brand">
          <div class="brand-icon">üïâÔ∏è</div>
          <div class="brand-text">
            <h1>Vedic Studio Ultra</h1>
            <p>Complete Pooja Management</p>
          </div>
        </div>
        <div class="nav-actions">
          <button class="nav-btn" onclick="app.openSettings()" title="Settings">‚öôÔ∏è</button>
        </div>
      </div>
    </div>

    <div class="main-content">
      
      <!-- HOME PAGE -->
      <section id="homePage" class="page-section active">
        <div class="section-header">
          <h2 class="section-title">Dashboard</h2>
          <p class="section-subtitle">Welcome to your spiritual workspace</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-value" id="totalYajmans">0</div>
            <div class="stat-label">Total Yajmans</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üïâÔ∏è</div>
            <div class="stat-value" id="totalPoojas">0</div>
            <div class="stat-label">Total Poojas</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üì¶</div>
            <div class="stat-value" id="totalItems">0</div>
            <div class="stat-label">Samagri Items</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚òÅÔ∏è</div>
            <div class="stat-value" id="cloudSaved">0</div>
            <div class="stat-label">Cloud Saved</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><span>‚ö°</span>Quick Actions</h3>
          </div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
            <button class="btn btn-primary" onclick="app.navigateTo('setupPage')">‚ûï New Pooja</button>
            <button class="btn btn-secondary" onclick="app.navigateTo('libraryPage')">üìö Library</button>
            <button class="btn btn-secondary" onclick="app.navigateTo('databasePage')">üóÑÔ∏è Database</button>
            <button class="btn btn-secondary" onclick="app.openModal('addModal')">‚ûï Add Data</button>
            <button class="btn btn-secondary" onclick="app.navigateTo('rashifalPage')">üåü Rashifal</button>
          </div>
        </div>
      </section>

      <!-- SETUP PAGE -->
      <section id="setupPage" class="page-section">
        <div class="section-header">
          <h2 class="section-title">Setup New Pooja</h2>
          <p class="section-subtitle">Configure yajman and pandit details</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><span>üôè</span>Select Pandit</h3>
          </div>
          <div class="pandit-grid" id="panditGrid"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><span>üë§</span>Yajman Details</h3>
          </div>
          <div class="form-group">
            <label class="form-label">Yajman Name</label>
            <input type="text" class="form-input" id="yajmanName" placeholder="Enter yajman name">
          </div>
          <div class="form-group">
            <label class="form-label">Phone Number</label>
            <input type="tel" class="form-input" id="yajmanPhone" placeholder="Enter phone number">
          </div>
          <div class="form-group">
            <label class="form-label">Date</label>
            <input type="date" class="form-input" id="poojaDate">
          </div>
        </div>

        <button class="btn btn-primary btn-block" onclick="app.proceedToPoojaSelection()">
          Next: Select Pooja ‚Üí
        </button>
      </section>

      <!-- POOJA SELECTION PAGE -->
      <section id="poojaPage" class="page-section">
        <div class="section-header">
          <h2 class="section-title">Select Poojas</h2>
          <p class="section-subtitle">Choose and arrange poojas in order</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><span>üïâÔ∏è</span>Available Poojas</h3>
            <div style="display: flex; gap: 0.5rem;">
              <button class="btn btn-sm btn-secondary" onclick="app.selectAllPoojas()">Select All</button>
              <button class="btn btn-sm btn-secondary" onclick="app.clearPoojas()">Clear All</button>
            </div>
          </div>
          <div class="pooja-grid" id="poojaGrid"></div>
        </div>

        <button class="btn btn-primary btn-block" onclick="app.proceedToMaterials()">
          Next: Manage Materials ‚Üí
        </button>
      </section>

      <!-- MATERIALS PAGE -->
      <section id="materialsPage" class="page-section">
        <div class="section-header">
          <h2 class="section-title">Material Management</h2>
          <p class="section-subtitle">Customize quantities and units</p>
        </div>

        <div id="materialSections"></div>

        <div class="card">
          <button class="btn btn-success btn-block" onclick="app.saveToCloud()">üíæ Save to Cloud</button>
          <button class="btn btn-primary btn-block mt-2" onclick="app.proceedToPreview()">Next: Preview & Download ‚Üí</button>
        </div>
      </section>

      <!-- PREVIEW PAGE -->
      <section id="previewPage" class="page-section">
        <div class="section-header">
          <h2 class="section-title">Preview & Download</h2>
          <p class="section-subtitle">Edit headers and download PDF</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><span>üìÑ</span>PDF Preview (Click to Edit)</h3>
            <button class="btn btn-sm btn-secondary" onclick="app.refreshPreview()">üîÑ Refresh</button>
          </div>
          <div class="pdf-preview-container" id="pdfPreviewContainer">
            <p style="color: #666; text-align: center; padding: 2rem;">Click "Refresh" to generate preview</p>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><span>üì•</span>Download Options</h3>
          </div>
          <div class="grid gap-2" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <button class="btn btn-primary" onclick="app.downloadMultiPagePDF()">üìÑ Multi-page PDF</button>
            <button class="btn btn-success" onclick="app.downloadImagesZIP()">üóÇÔ∏è Images ZIP</button>
            <button class="btn btn-secondary" onclick="app.shareWhatsApp()">üì± Share WhatsApp</button>
            <button class="btn btn-secondary" onclick="app.printDocument()">üñ®Ô∏è Print</button>
          </div>
        </div>
      </section>

      <!-- LIBRARY PAGE -->
      <section id="libraryPage" class="page-section">
        <div class="section-header">
          <h2 class="section-title">Cloud Library</h2>
          <p class="section-subtitle">Manage your saved templates</p>
        </div>

        <div class="card">
          <div class="form-group">
            <input type="text" class="form-input" id="librarySearch" placeholder="üîç Search templates..." oninput="app.filterTemplates()">
          </div>
        </div>

        <div class="template-grid" id="templateGrid">
          <p style="color: var(--gray-400); text-align: center; padding: 2rem;">Loading templates...</p>
        </div>
      </section>

      <!-- DATABASE PAGE -->
      <section id="databasePage" class="page-section">
        <div class="section-header">
          <h2 class="section-title">Database Management</h2>
          <p class="section-subtitle">Edit, add, delete pooja and samagri data</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><span>üóÑÔ∏è</span>Master Database</h3>
            <button class="btn btn-sm btn-primary" onclick="app.openModal('addModal')">‚ûï Add New</button>
          </div>
          <div style="overflow-x: auto;">
            <table class="db-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Pooja Name</th>
                  <th>Samagri</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="databaseTableBody">
                <tr><td colspan="4" style="text-align: center; padding: 2rem;">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><span>üìä</span>Statistics</h3>
          </div>
          <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
            <div style="text-align: center; padding: 1rem; background: rgba(255,111,0,0.1); border-radius: var(--radius-md);">
              <div style="font-size: 2rem; font-weight: 800; color: white;" id="dbTotalPoojas">0</div>
              <div style="font-size: 0.875rem; color: var(--gray-400);">Total Poojas</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: rgba(255,111,0,0.1); border-radius: var(--radius-md);">
              <div style="font-size: 2rem; font-weight: 800; color: white;" id="dbTotalSamagri">0</div>
              <div style="font-size: 0.875rem; color: var(--gray-400);">Total Items</div>
            </div>
          </div>
        </div>
      </section>

      <!-- RASHIFAL PAGE -->
      <section id="rashifalPage" class="page-section">
        <div class="section-header">
          <h2 class="section-title">Rashifal Creator</h2>
          <p class="section-subtitle">Create beautiful horoscope posts</p>
        </div>
        <iframe src="https://jaiminihome-ship-it.github.io/POOJASAMAGRI/Rashi.html" style="width: 100%; height: calc(100vh - 250px); border: none; border-radius: var(--radius-lg); background: white;"></iframe>
      </section>

    </div>

    <div class="bottom-nav">
      <div class="bottom-nav-glass">
        <button class="tab-btn active" data-page="homePage" onclick="app.navigateTo('homePage')">
          <span class="tab-icon">üè†</span><span>Home</span>
        </button>
        <button class="tab-btn" data-page="setupPage" onclick="app.navigateTo('setupPage')">
          <span class="tab-icon">‚ûï</span><span>New</span>
        </button>
        <button class="tab-btn" data-page="libraryPage" onclick="app.navigateTo('libraryPage')">
          <span class="tab-icon">üìö</span><span>Library</span>
        </button>
        <button class="tab-btn" data-page="databasePage" onclick="app.navigateTo('databasePage')">
          <span class="tab-icon">üóÑÔ∏è</span><span>Database</span>
        </button>
        <button class="tab-btn" data-page="rashifalPage" onclick="app.navigateTo('rashifalPage')">
          <span class="tab-icon">üåü</span><span>Rashifal</span>
        </button>
        <button class="tab-btn" onclick="app.openSettings()">
          <span class="tab-icon">‚öôÔ∏è</span><span>Settings</span>
        </button>
      </div>
    </div>

  </div>

  <div id="pdfPagesContainer"></div>

  <script>
    const app = {
      API_URL: "https://script.google.com/macros/s/AKfycbyhXVfu7WVAs2pQQLyH3lkkO3ZG-rmbqTmyygjqH8XeWyQPNgqx49whCIsa8WttKRZ4/exec",
      
      PDF_CONFIG: {
        FIRST_PAGE_ROWS: 15,
        SUBSEQUENT_PAGE_ROWS: 20
      },
      
      pandits: {
        yugal: {
          id: 'yugal',
          name: '‡§™‡§Ç. ‡§Ø‡•Å‡§ó‡§≤ ‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø',
          title: '‡§µ‡•à‡§¶‡§ø‡§ï ‡§ú‡•ç‡§Ø‡•ã‡§§‡§ø‡§∑‡§æ‡§ö‡§æ‡§∞‡•ç‡§Ø ‡§è‡§µ‡§Ç ‡§µ‡§æ‡§∏‡•ç‡§§‡•Å ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û',
          phone: '+91 9928139485',
          website: 'www.astroyugalacharya.in',
          address: '‡§ú‡§Ø‡§™‡•Å‡§∞, ‡§∞‡§æ‡§ú‡§∏‡•ç‡§•‡§æ‡§®'
        },
        purushottam: {
          id: 'purushottam',
          name: '‡§™‡§Ç. ‡§™‡•Å‡§∞‡•Å‡§∑‡•ã‡§§‡•ç‡§§‡§Æ ‡§∂‡§∞‡•ç‡§Æ‡§æ',
          title: '‡§ú‡•ç‡§Ø‡•ã‡§§‡§ø‡§∑‡§æ‡§ö‡§æ‡§∞‡•ç‡§Ø',
          phone: '+91 9680992496',
          address: '‡§∂‡•ç‡§∞‡•Ä ‡§∞‡§æ‡§Æ ‡§Æ‡§Ç‡§¶‡§ø‡§∞, ‡§ó‡§ø‡§∞‡§®‡§æ‡§∞ ‡§ï‡•â‡§≤‡•ã‡§®‡•Ä, ‡§µ‡•à‡§∂‡§æ‡§≤‡•Ä ‡§®‡§ó‡§∞, ‡§ú‡§Ø‡§™‡•Å‡§∞'
        }
      },

      state: {
        currentPage: 'homePage',
        selectedPandit: 'yugal',
        selectedPoojas: [],
        materials: [],
        templates: [],
        masterData: [],
        editableData: {} // Store editable values
      },

      async init() {
        console.log('üïâÔ∏è Initializing...');
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('poojaDate').value = today;
        
        this.loadSettings();
        await this.loadMasterData();
        await this.loadTemplates();
        
        this.renderPanditSelection();
        this.updateStats();
        this.updateDatabaseStats();
        this.loadSavedState();
        
        this.toast('‚ú® Ready!', 'System initialized', 'success');
      },

      loadSettings() {
        const saved = localStorage.getItem('pdfSettings');
        if (saved) {
          try {
            const settings = JSON.parse(saved);
            this.PDF_CONFIG.FIRST_PAGE_ROWS = settings.firstPageRows || 15;
            this.PDF_CONFIG.SUBSEQUENT_PAGE_ROWS = settings.subsequentPageRows || 20;
            
            document.getElementById('settingFirstPageRows').value = this.PDF_CONFIG.FIRST_PAGE_ROWS;
            document.getElementById('settingSubsequentPageRows').value = this.PDF_CONFIG.SUBSEQUENT_PAGE_ROWS;
          } catch (e) {}
        }
      },

      saveSettings() {
        const firstPageRows = parseInt(document.getElementById('settingFirstPageRows').value);
        const subsequentPageRows = parseInt(document.getElementById('settingSubsequentPageRows').value);
        
        this.PDF_CONFIG.FIRST_PAGE_ROWS = firstPageRows;
        this.PDF_CONFIG.SUBSEQUENT_PAGE_ROWS = subsequentPageRows;
        
        localStorage.setItem('pdfSettings', JSON.stringify({ firstPageRows, subsequentPageRows }));
        
        this.closeModal('settingsModal');
        this.toast('‚úÖ Saved', 'Settings updated', 'success');
      },

      async loadMasterData() {
        this.showLoading('Loading data...');
        try {
          const response = await fetch(this.API_URL);
          const data = await response.json();
          this.state.masterData = data;
          console.log('üì¶ Loaded', data.length, 'items');
          this.renderPoojaGrid();
          this.renderDatabaseTable();
          this.updateDatabaseStats();
          this.updateExistingPoojaSelect();
          this.hideLoading();
        } catch (error) {
          console.error('Failed:', error);
          this.hideLoading();
          this.toast('‚ö†Ô∏è Error', 'Failed to load data', 'error');
        }
      },

      async loadTemplates() {
        try {
          // Fetch from Templates sheet
          const response = await fetch(`${this.API_URL}?sheet=Templates`);
          const text = await response.text();
          
          console.log('Template response:', text);
          
          try {
            const data = JSON.parse(text);
            
            // Parse template data based on sheet structure: Yajman_Name, Date, Pooja_List, Samagri_Data, ID
            this.state.templates = Array.isArray(data) ? data.map(row => {
              try {
                // Parse samagri data if it's JSON string
                let samagriData = [];
                if (row.Samagri_Data) {
                  try {
                    samagriData = typeof row.Samagri_Data === 'string' ? 
                      JSON.parse(row.Samagri_Data) : row.Samagri_Data;
                  } catch (e) {
                    console.warn('Failed to parse samagri:', e);
                  }
                }
                
                return {
                  id: row.ID || row.id || Date.now().toString(),
                  name: row.Yajman_Name || row.name || 'Unknown',
                  date: row.Date || row.date || '',
                  poojas: row.Pooja_List || row.poojas || '',
                  samagri: samagriData
                };
              } catch (e) {
                console.error('Error parsing row:', e, row);
                return null;
              }
            }).filter(Boolean) : [];
            
            console.log('üìö Loaded', this.state.templates.length, 'templates');
            this.renderTemplateGrid();
            this.updateStats();
          } catch (parseError) {
            console.error('JSON parse error:', parseError);
            this.state.templates = [];
          }
        } catch (error) {
          console.error('Failed to load templates:', error);
          this.state.templates = [];
        }
      },

      renderDatabaseTable() {
        const tbody = document.getElementById('databaseTableBody');
        if (this.state.masterData.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem;">No data</td></tr>';
          return;
        }
        tbody.innerHTML = this.state.masterData.map((item, index) => `
          <tr>
            <td>${index + 1}</td>
            <td><strong>${item.pooja || 'N/A'}</strong></td>
            <td>${item.samagri || 'N/A'}</td>
            <td>
              <div class="db-actions">
                <button class="db-btn db-btn-edit" onclick="app.editDatabaseItem(${index})">Edit</button>
                <button class="db-btn db-btn-delete" onclick="app.deleteDatabaseItem(${index})">Delete</button>
              </div>
            </td>
          </tr>
        `).join('');
      },

      updateDatabaseStats() {
        const uniquePoojas = [...new Set(this.state.masterData.map(x => x.pooja?.trim()))].filter(Boolean);
        document.getElementById('dbTotalPoojas').textContent = uniquePoojas.length;
        document.getElementById('dbTotalSamagri').textContent = this.state.masterData.length;
      },

      updateExistingPoojaSelect() {
        const uniquePoojas = [...new Set(this.state.masterData.map(x => x.pooja?.trim()))].filter(Boolean);
        const select = document.getElementById('existingPoojaSelect');
        select.innerHTML = '<option value="">Or select existing</option>' + 
          uniquePoojas.map(p => `<option value="${p}">${p}</option>`).join('');
      },

      selectExistingPooja() {
        const select = document.getElementById('existingPoojaSelect');
        const input = document.getElementById('modalPoojaName');
        if (select.value) input.value = select.value;
      },

      async saveToDatabase() {
        const poojaName = document.getElementById('modalPoojaName').value.trim();
        const samagriText = document.getElementById('modalSamagriItems').value.trim();

        if (!poojaName || !samagriText) {
          this.toast('‚ö†Ô∏è Error', 'Fill all fields', 'error');
          return;
        }

        const items = samagriText.split('\n').filter(i => i.trim());
        this.showLoading('Adding...');
        
        try {
          for (const item of items) {
            await fetch(this.API_URL, {
              method: 'POST',
              body: JSON.stringify({
                action: 'add',
                pooja: poojaName,
                samagri: item.trim()
              })
            });
          }
          
          this.closeModal('addModal');
          this.hideLoading();
          this.toast('‚úÖ Success', `Added ${items.length} items`, 'success');
          
          document.getElementById('modalPoojaName').value = '';
          document.getElementById('modalSamagriItems').value = '';
          document.getElementById('existingPoojaSelect').value = '';
          
          await this.loadMasterData();
        } catch (error) {
          this.hideLoading();
          this.toast('‚ùå Failed', error.message, 'error');
        }
      },

      editDatabaseItem(index) {
        const item = this.state.masterData[index];
        document.getElementById('editPoojaName').value = item.pooja || '';
        document.getElementById('editSamagriName').value = item.samagri || '';
        document.getElementById('editRowIndex').value = index;
        this.openModal('editModal');
      },

      async updateDatabaseItem() {
        const index = parseInt(document.getElementById('editRowIndex').value);
        const newSamagri = document.getElementById('editSamagriName').value.trim();
        
        if (!newSamagri) {
          this.toast('‚ö†Ô∏è Error', 'Cannot be empty', 'error');
          return;
        }

        this.showLoading('Updating...');
        
        try {
          const oldItem = this.state.masterData[index];
          
          await fetch(this.API_URL, {
            method: 'POST',
            body: JSON.stringify({
              action: 'delete',
              pooja: oldItem.pooja,
              samagri: oldItem.samagri
            })
          });
          
          await fetch(this.API_URL, {
            method: 'POST',
            body: JSON.stringify({
              action: 'add',
              pooja: oldItem.pooja,
              samagri: newSamagri
            })
          });
          
          this.closeModal('editModal');
          this.hideLoading();
          this.toast('‚úÖ Updated', 'Item updated', 'success');
          await this.loadMasterData();
        } catch (error) {
          this.hideLoading();
          this.toast('‚ùå Failed', error.message, 'error');
        }
      },

      async deleteDatabaseItem(index) {
        if (!confirm('Delete this item?')) return;
        
        this.showLoading('Deleting...');
        
        try {
          const item = this.state.masterData[index];
          await fetch(this.API_URL, {
            method: 'POST',
            body: JSON.stringify({
              action: 'delete',
              pooja: item.pooja,
              samagri: item.samagri
            })
          });
          
          this.hideLoading();
          this.toast('‚úÖ Deleted', 'Item deleted', 'success');
          await this.loadMasterData();
        } catch (error) {
          this.hideLoading();
          this.toast('‚ùå Failed', error.message, 'error');
        }
      },

      renderPanditSelection() {
        const grid = document.getElementById('panditGrid');
        grid.innerHTML = Object.values(this.pandits).map(pandit => `
          <div class="pandit-card ${this.state.selectedPandit === pandit.id ? 'selected' : ''}" 
               onclick="app.selectPandit('${pandit.id}')">
            <div class="pandit-header">
              <div class="pandit-avatar">üôè</div>
              <div class="pandit-info">
                <h3>${pandit.name}</h3>
                <p>${pandit.title}</p>
              </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem; color: var(--gray-300);">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span>üìû</span><span>${pandit.phone}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span>üìç</span><span>${pandit.address}</span>
              </div>
              ${pandit.website ? `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span>üåê</span><span>${pandit.website}</span>
                </div>
              ` : ''}
            </div>
          </div>
        `).join('');
      },

      selectPandit(panditId) {
        this.state.selectedPandit = panditId;
        this.renderPanditSelection();
        this.saveState();
        this.toast('‚úÖ Selected', this.pandits[panditId].name, 'success');
      },

      renderPoojaGrid() {
        const uniquePoojas = [...new Set(this.state.masterData.map(x => x.pooja?.trim()))].filter(Boolean);
        const grid = document.getElementById('poojaGrid');
        
        if (uniquePoojas.length === 0) {
          grid.innerHTML = '<p style="color: var(--gray-400); text-align: center; padding: 2rem;">No poojas found</p>';
          return;
        }
        
        grid.innerHTML = uniquePoojas.map(pooja => {
          const itemCount = this.state.masterData.filter(x => x.pooja === pooja).length;
          const isSelected = this.state.selectedPoojas.some(p => p.name === pooja);
          const index = this.state.selectedPoojas.findIndex(p => p.name === pooja);
          
          return `
            <div class="pooja-item ${isSelected ? 'selected' : ''}" onclick="app.togglePooja('${pooja}')">
              <div class="pooja-checkbox"></div>
              <div class="pooja-content">
                <div class="pooja-name">${pooja}</div>
                <div class="pooja-count">${itemCount} items</div>
              </div>
              ${isSelected ? `
                <div class="pooja-actions">
                  <button class="pooja-action-btn" onclick="event.stopPropagation(); app.movePoojaUp(${index})">‚ñ≤</button>
                  <button class="pooja-action-btn" onclick="event.stopPropagation(); app.movePoojaDown(${index})">‚ñº</button>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      },

      togglePooja(poojaName) {
        const index = this.state.selectedPoojas.findIndex(p => p.name === poojaName);
        if (index > -1) {
          this.state.selectedPoojas.splice(index, 1);
        } else {
          this.state.selectedPoojas.push({ name: poojaName, order: this.state.selectedPoojas.length });
        }
        this.renderPoojaGrid();
        this.saveState();
      },

      movePoojaUp(index) {
        if (index > 0) {
          [this.state.selectedPoojas[index], this.state.selectedPoojas[index - 1]] = 
          [this.state.selectedPoojas[index - 1], this.state.selectedPoojas[index]];
          this.renderPoojaGrid();
          this.saveState();
        }
      },

      movePoojaDown(index) {
        if (index < this.state.selectedPoojas.length - 1) {
          [this.state.selectedPoojas[index], this.state.selectedPoojas[index + 1]] = 
          [this.state.selectedPoojas[index + 1], this.state.selectedPoojas[index]];
          this.renderPoojaGrid();
          this.saveState();
        }
      },

      selectAllPoojas() {
        const uniquePoojas = [...new Set(this.state.masterData.map(x => x.pooja?.trim()))].filter(Boolean);
        this.state.selectedPoojas = uniquePoojas.map((name, order) => ({ name, order }));
        this.renderPoojaGrid();
        this.saveState();
        this.toast('‚úÖ All Selected', `${uniquePoojas.length} poojas`, 'success');
      },

      clearPoojas() {
        this.state.selectedPoojas = [];
        this.renderPoojaGrid();
        this.saveState();
        this.toast('üóëÔ∏è Cleared', 'All removed', 'info');
      },

      proceedToPoojaSelection() {
        const yajman = document.getElementById('yajmanName').value.trim();
        if (!yajman) {
          this.toast('‚ö†Ô∏è Error', 'Enter yajman name', 'error');
          return;
        }
        this.state.yajmanName = yajman;
        this.state.yajmanPhone = document.getElementById('yajmanPhone').value.trim();
        this.state.poojaDate = document.getElementById('poojaDate').value;
        this.navigateTo('poojaPage');
        this.saveState();
      },

      proceedToMaterials() {
        if (this.state.selectedPoojas.length === 0) {
          this.toast('‚ö†Ô∏è Error', 'Select at least one pooja', 'error');
          return;
        }
        this.generateMaterialList();
        this.renderMaterialSections();
        this.navigateTo('materialsPage');
      },

      generateMaterialList() {
        this.state.materials = [];
        this.state.selectedPoojas.forEach(pooja => {
          const poojaItems = this.state.masterData.filter(d => d.pooja === pooja.name);
          poojaItems.forEach(item => {
            this.state.materials.push({
              pooja: pooja.name,
              name: item.samagri,
              qty: '',
              unit: '',
              included: true
            });
          });
        });
      },

      renderMaterialSections() {
        const container = document.getElementById('materialSections');
        const sections = this.state.selectedPoojas.map(pooja => {
          const materials = this.state.materials.filter(m => m.pooja === pooja.name);
          return `
            <div class="material-section card">
              <div class="material-header">
                <div class="material-title">
                  <span>üïâÔ∏è</span>
                  <span>${pooja.name}</span>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="app.toggleAllMaterials('${pooja.name}')">
                  Toggle All
                </button>
              </div>
              <div class="material-list">
                ${materials.map((material, idx) => `
                  <div class="material-item">
                    <input type="checkbox" class="material-check" 
                           ${material.included ? 'checked' : ''}
                           onchange="app.toggleMaterial('${pooja.name}', ${idx})">
                    <div class="material-name">${material.name}</div>
                    <input type="text" class="material-qty" 
                           placeholder="Qty" 
                           value="${material.qty}"
                           oninput="app.updateMaterialQty('${pooja.name}', ${idx}, this.value)">
                    <select class="material-unit" 
                            onchange="app.updateMaterialUnit('${pooja.name}', ${idx}, this.value)">
                      <option value="">Unit</option>
                      <option ${material.unit === '‡§ó‡•ç‡§∞‡§æ‡§Æ' ? 'selected' : ''}>‡§ó‡•ç‡§∞‡§æ‡§Æ</option>
                      <option ${material.unit === '‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ' ? 'selected' : ''}>‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ</option>
                      <option ${material.unit === '‡§®‡§ó' ? 'selected' : ''}>‡§®‡§ó</option>
                      <option ${material.unit === '‡§™‡•à‡§ï‡•á‡§ü' ? 'selected' : ''}>‡§™‡•à‡§ï‡•á‡§ü</option>
                      <option ${material.unit === '‡§∞‡•Å‡§™‡§Ø‡•á' ? 'selected' : ''}>‡§∞‡•Å‡§™‡§Ø‡•á</option>
                      <option ${material.unit === '‡§≤‡•Ä‡§ü‡§∞' ? 'selected' : ''}>‡§≤‡•Ä‡§ü‡§∞</option>
                    </select>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }).join('');
        container.innerHTML = sections;
      },

      toggleMaterial(poojaName, index) {
        const materials = this.state.materials.filter(m => m.pooja === poojaName);
        if (materials[index]) {
          materials[index].included = !materials[index].included;
          this.saveState();
        }
      },

      updateMaterialQty(poojaName, index, qty) {
        const materials = this.state.materials.filter(m => m.pooja === poojaName);
        if (materials[index]) {
          materials[index].qty = qty;
          this.saveState();
        }
      },

      updateMaterialUnit(poojaName, index, unit) {
        const materials = this.state.materials.filter(m => m.pooja === poojaName);
        if (materials[index]) {
          materials[index].unit = unit;
          this.saveState();
        }
      },

      toggleAllMaterials(poojaName) {
        const materials = this.state.materials.filter(m => m.pooja === poojaName);
        const allChecked = materials.every(m => m.included);
        materials.forEach(m => m.included = !allChecked);
        this.renderMaterialSections();
        this.saveState();
      },

      async saveToCloud() {
        const yajman = this.state.yajmanName || 'Unnamed';
        const payload = {
          action: 'saveTemplate',
          sheet: 'Templates', // Specify Templates sheet
          yajman_name: yajman,
          date: this.state.poojaDate || new Date().toLocaleDateString('hi-IN'),
          pooja_list: this.state.selectedPoojas.map(p => p.name).join(', '),
          samagri_data: JSON.stringify(this.state.materials.filter(m => m.included)),
          id: Date.now().toString()
        };

        this.showLoading('Saving...');
        try {
          await fetch(this.API_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
          });
          this.hideLoading();
          this.toast('‚úÖ Saved', 'Template saved', 'success');
          await this.loadTemplates();
        } catch (error) {
          this.hideLoading();
          this.toast('‚ùå Failed', 'Could not save', 'error');
        }
      },

      renderTemplateGrid() {
        const grid = document.getElementById('templateGrid');
        
        if (this.state.templates.length === 0) {
          grid.innerHTML = '<p style="color: var(--gray-400); text-align: center; padding: 2rem;">No templates</p>';
          return;
        }
        
        grid.innerHTML = this.state.templates.slice().reverse().map(template => `
          <div class="template-card">
            <div class="template-name">${template.name}</div>
            <div class="template-meta">
              <span>üìÖ ${template.date}</span>
              <span>üïâÔ∏è ${template.poojas?.split(',').length || 0} poojas</span>
            </div>
            <div class="template-actions">
              <button class="btn btn-sm btn-primary" onclick="app.loadTemplate('${template.id}')">Open</button>
              <button class="btn btn-sm btn-secondary" onclick="app.cloneTemplate('${template.id}')">Clone</button>
              <button class="btn btn-sm btn-danger" onclick="app.deleteTemplate('${template.id}')">Delete</button>
            </div>
          </div>
        `).join('');
      },

      filterTemplates() {
        const search = document.getElementById('librarySearch').value.toLowerCase();
        const filtered = this.state.templates.filter(t => 
          t.name.toLowerCase().includes(search) ||
          (t.poojas && t.poojas.toLowerCase().includes(search))
        );
        
        const grid = document.getElementById('templateGrid');
        if (filtered.length === 0) {
          grid.innerHTML = '<p style="color: var(--gray-400); text-align: center; padding: 2rem;">No matching templates</p>';
          return;
        }
        
        grid.innerHTML = filtered.map(template => `
          <div class="template-card">
            <div class="template-name">${template.name}</div>
            <div class="template-meta">
              <span>üìÖ ${template.date}</span>
              <span>üïâÔ∏è ${template.poojas?.split(',').length || 0} poojas</span>
            </div>
            <div class="template-actions">
              <button class="btn btn-sm btn-primary" onclick="app.loadTemplate('${template.id}')">Open</button>
              <button class="btn btn-sm btn-secondary" onclick="app.cloneTemplate('${template.id}')">Clone</button>
              <button class="btn btn-sm btn-danger" onclick="app.deleteTemplate('${template.id}')">Delete</button>
            </div>
          </div>
        `).join('');
      },

      loadTemplate(id) {
        const template = this.state.templates.find(t => t.id.toString() === id.toString());
        if (!template) return;
        
        this.state.yajmanName = template.name;
        this.state.poojaDate = template.date;
        this.state.selectedPoojas = (template.poojas || '').split(', ').filter(Boolean).map((name, order) => ({ name: name.trim(), order }));
        this.state.materials = template.samagri || [];
        
        document.getElementById('yajmanName').value = template.name;
        document.getElementById('poojaDate').value = template.date;
        
        this.renderPoojaGrid();
        this.renderMaterialSections();
        this.navigateTo('materialsPage');
        
        this.toast('‚úÖ Loaded', template.name, 'success');
      },

      async cloneTemplate(id) {
        const template = this.state.templates.find(t => t.id.toString() === id.toString());
        if (!template) return;
        
        const newName = prompt('New name:', template.name + ' (Copy)');
        if (!newName) return;
        
        const payload = {
          action: 'saveTemplate',
          sheet: 'Templates',
          yajman_name: newName,
          date: new Date().toLocaleDateString('hi-IN'),
          pooja_list: template.poojas,
          samagri_data: JSON.stringify(template.samagri),
          id: Date.now().toString()
        };
        
        this.showLoading('Cloning...');
        try {
          await fetch(this.API_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
          });
          this.hideLoading();
          this.toast('‚úÖ Cloned', newName, 'success');
          await this.loadTemplates();
        } catch (error) {
          this.hideLoading();
          this.toast('‚ùå Failed', error.message, 'error');
        }
      },

      async deleteTemplate(id) {
        if (!confirm('Delete?')) return;
        
        this.showLoading('Deleting...');
        try {
          await fetch(this.API_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'deleteTemplate', sheet: 'Templates', id: id })
          });
          this.hideLoading();
          this.toast('‚úÖ Deleted', 'Template removed', 'success');
          await this.loadTemplates();
        } catch (error) {
          this.hideLoading();
          this.toast('‚ùå Failed', error.message, 'error');
        }
      },

      proceedToPreview() {
        // Initialize editable data with current values
        this.state.editableData = {
          yajmanName: this.state.yajmanName || '',
          yajmanPhone: this.state.yajmanPhone || '',
          poojaDate: this.state.poojaDate || '',
          poojas: this.state.selectedPoojas.map(p => p.name).join(', ')
        };
        
        this.navigateTo('previewPage');
        setTimeout(() => this.refreshPreview(), 500);
      },

      refreshPreview() {
        this.showLoading('Generating preview...');
        
        try {
          const includedMaterials = this.state.materials.filter(m => m.included);
          const previewHTML = this.createPDFPreviewHTML(includedMaterials);
          
          const container = document.getElementById('pdfPreviewContainer');
          container.innerHTML = previewHTML;
          
          // Make fields editable after rendering
          this.makeFieldsEditable();
          
          this.hideLoading();
          this.toast('‚úÖ Preview Ready', 'Click fields to edit', 'success');
        } catch (error) {
          this.hideLoading();
          this.toast('‚ùå Failed', error.message, 'error');
          console.error(error);
        }
      },

      // Create HTML for preview with editable fields
      createPDFPreviewHTML(materials) {
        const pandit = this.pandits[this.state.selectedPandit];
        const pages = [];
        
        const groupedMaterials = [];
        this.state.selectedPoojas.forEach(pooja => {
          const poojaItems = materials.filter(m => m.pooja === pooja.name);
          if (poojaItems.length > 0) {
            groupedMaterials.push({
              poojaName: pooja.name,
              items: poojaItems
            });
          }
        });
        
        let currentPageHTML = '';
        let currentRowCount = 0;
        let pageNum = 1;
        
        const createPageStart = (isFirst) => {
          if (isFirst) {
            return `
              <div class="pdf-preview-page">
                <div class="page-number">Page ${pageNum}</div>
                <div style="text-align: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 3px solid #FF6F00;">
                  <h1 style="color: #FF6F00; font-size: 28px; margin: 0 0 5px 0; font-weight: 700;">‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É ‡••</h1>
                  <h2 style="color: #333; font-size: 22px; margin: 0; font-weight: 600;">‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</h2>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: #f9f9f9; padding: 12px; border-radius: 6px; border: 1px solid #e0e0e0; font-size: 13px; margin-bottom: 15px;">
                  <div><strong style="color: #FF6F00;">‡§Ø‡§ú‡§Æ‡§æ‡§®:</strong> <span class="editable" contenteditable="true" data-field="yajmanName">${this.state.editableData.yajmanName}</span></div>
                  <div><strong style="color: #FF6F00;">‡§§‡§æ‡§∞‡•Ä‡§ñ:</strong> <span class="editable" contenteditable="true" data-field="poojaDate">${this.state.editableData.poojaDate}</span></div>
                  <div><strong style="color: #FF6F00;">‡§™‡§Ç‡§°‡§ø‡§§:</strong> ${pandit.name}</div>
                  <div><strong style="color: #FF6F00;">‡§´‡•ã‡§®:</strong> <span class="editable" contenteditable="true" data-field="yajmanPhone">${this.state.editableData.yajmanPhone}</span></div>
                  <div style="grid-column: 1 / -1;"><strong style="color: #FF6F00;">‡§™‡•Ç‡§ú‡§æ:</strong> <span class="editable" contenteditable="true" data-field="poojas">${this.state.editableData.poojas}</span></div>
                </div>
                <div class="content">
            `;
          } else {
            return `
              <div class="pdf-preview-page">
                <div class="page-number">Page ${pageNum}</div>
                <div class="content" style="padding-top: 20px;">
            `;
          }
        };
        
        const createPageEnd = () => {
          return `
                </div>
                <div style="margin-top: 15px; padding-top: 12px; border-top: 3px solid #FF6F00; text-align: center; color: #555; font-size: 11px;">
                  <div style="margin-bottom: 4px;"><strong>‡§™‡§Ç‡§°‡§ø‡§§:</strong> ${pandit.name} | <strong>‡§´‡•ã‡§®:</strong> ${pandit.phone}</div>
                  <div><strong>‡§™‡§§‡§æ:</strong> ${pandit.address}</div>
                  ${pandit.website ? `<div><strong>‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü:</strong> ${pandit.website}</div>` : ''}
                </div>
              </div>
            `;
        };
        
        currentPageHTML = createPageStart(true);
        let contentHTML = '';
        
        groupedMaterials.forEach(group => {
          const headingHTML = `<h3 style="background: #FF6F00; color: white; padding: 6px 10px; margin: 10px 0 8px 0; border-radius: 4px; font-weight: 600; font-size: 14px;">üïâÔ∏è ${group.poojaName}</h3>`;
          
          let tableHTML = `
            <table style="width: 100%; border-collapse: collapse; border: 2px solid #333; margin-bottom: 10px; font-size: 12px;">
              <thead>
                <tr style="background: #f5f5f5;">
                  <th style="border: 1px solid #666; padding: 6px; text-align: left; color: #FF6F00; font-weight: 600;">‡§∏‡§æ‡§Æ‡§æ‡§®</th>
                  <th style="border: 1px solid #666; padding: 6px; text-align: left; color: #FF6F00; font-weight: 600;">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>
                  <th style="border: 1px solid #666; padding: 6px; text-align: left; color: #FF6F00; font-weight: 600;">‡§∏‡§æ‡§Æ‡§æ‡§®</th>
                  <th style="border: 1px solid #666; padding: 6px; text-align: left; color: #FF6F00; font-weight: 600;">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          const pairs = this.chunkArray(group.items, 2);
          let rowsHTML = '';
          
          pairs.forEach(pair => {
            const currentMaxRows = pageNum === 1 ? this.PDF_CONFIG.FIRST_PAGE_ROWS : this.PDF_CONFIG.SUBSEQUENT_PAGE_ROWS;
            
            if (currentRowCount >= currentMaxRows) {
              // Close current table and page
              tableHTML += rowsHTML + '</tbody></table>';
              contentHTML += tableHTML;
              currentPageHTML += contentHTML + createPageEnd();
              pages.push(currentPageHTML);
              
              // Start new page
              pageNum++;
              currentPageHTML = createPageStart(false);
              contentHTML = headingHTML.replace(group.poojaName, group.poojaName + ' (‡§ú‡§æ‡§∞‡•Ä...)');
              tableHTML = `
                <table style="width: 100%; border-collapse: collapse; border: 2px solid #333; margin-bottom: 10px; font-size: 12px;">
                  <thead>
                    <tr style="background: #f5f5f5;">
                      <th style="border: 1px solid #666; padding: 6px; text-align: left; color: #FF6F00; font-weight: 600;">‡§∏‡§æ‡§Æ‡§æ‡§®</th>
                      <th style="border: 1px solid #666; padding: 6px; text-align: left; color: #FF6F00; font-weight: 600;">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>
                      <th style="border: 1px solid #666; padding: 6px; text-align: left; color: #FF6F00; font-weight: 600;">‡§∏‡§æ‡§Æ‡§æ‡§®</th>
                      <th style="border: 1px solid #666; padding: 6px; text-align: left; color: #FF6F00; font-weight: 600;">‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              rowsHTML = '';
              currentRowCount = 0;
            }
            
            rowsHTML += `
              <tr>
                <td style="border: 1px solid #666; padding: 5px; color: #333; font-weight: 500;">${pair[0]?.name || ''}</td>
                <td style="border: 1px solid #666; padding: 5px; color: #333; font-weight: 500;">${pair[0] ? (pair[0].qty + ' ' + pair[0].unit).trim() : ''}</td>
                <td style="border: 1px solid #666; padding: 5px; color: #333; font-weight: 500;">${pair[1]?.name || ''}</td>
                <td style="border: 1px solid #666; padding: 5px; color: #333; font-weight: 500;">${pair[1] ? (pair[1].qty + ' ' + pair[1].unit).trim() : ''}</td>
              </tr>
            `;
            currentRowCount++;
          });
          
          tableHTML += rowsHTML + '</tbody></table>';
          contentHTML += headingHTML + tableHTML;
        });
        
        // Close last page
        currentPageHTML += contentHTML + createPageEnd();
        pages.push(currentPageHTML);
        
        return pages.join('');
      },

      // Make preview fields editable
      makeFieldsEditable() {
        document.querySelectorAll('.editable').forEach(el => {
          el.addEventListener('blur', (e) => {
            const field = e.target.dataset.field;
            const value = e.target.textContent.trim();
            this.state.editableData[field] = value;
            console.log('Updated', field, '=', value);
          });
          
          el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              e.target.blur();
            }
          });
        });
      },

      // Create PDF pages for download (using editable data)
      createPDFPages(materials) {
        const container = document.getElementById('pdfPagesContainer');
        container.innerHTML = '';
        
        const pandit = this.pandits[this.state.selectedPandit];
        const pages = [];
        
        const groupedMaterials = [];
        this.state.selectedPoojas.forEach(pooja => {
          const poojaItems = materials.filter(m => m.pooja === pooja.name);
          if (poojaItems.length > 0) {
            groupedMaterials.push({
              poojaName: pooja.name,
              items: poojaItems
            });
          }
        });
        
        let currentPage = null;
        let currentRowCount = 0;
        let isFirstPage = true;
        
        const createNewPage = () => {
          const pageDiv = document.createElement('div');
          pageDiv.className = 'pdf-page';
          
          if (isFirstPage) {
            pageDiv.innerHTML = `
              <div class="pdf-header">
                <h1>‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§ó‡§£‡•á‡§∂‡§æ‡§Ø ‡§®‡§Æ‡§É ‡••</h1>
                <h2>‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä</h2>
              </div>
              <div class="pdf-details">
                <div><strong>‡§Ø‡§ú‡§Æ‡§æ‡§®:</strong> ${this.state.editableData.yajmanName || this.state.yajmanName || ''}</div>
                <div><strong>‡§§‡§æ‡§∞‡•Ä‡§ñ:</strong> ${this.state.editableData.poojaDate || this.state.poojaDate || ''}</div>
                <div><strong>‡§™‡§Ç‡§°‡§ø‡§§:</strong> ${pandit.name}</div>
                <div><strong>‡§´‡•ã‡§®:</strong> ${this.state.editableData.yajmanPhone || this.state.yajmanPhone || ''}</div>
                <div style="grid-column: 1 / -1;"><strong>‡§™‡•Ç‡§ú‡§æ:</strong> ${this.state.editableData.poojas || this.state.selectedPoojas.map(p => p.name).join(', ')}</div>
              </div>
              <div class="pdf-content"></div>
              <div class="pdf-footer">
                <div><strong>‡§™‡§Ç‡§°‡§ø‡§§:</strong> ${pandit.name} | <strong>‡§´‡•ã‡§®:</strong> ${pandit.phone}</div>
                <div><strong>‡§™‡§§‡§æ:</strong> ${pandit.address}</div>
                ${pandit.website ? `<div><strong>‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü:</strong> ${pandit.website}</div>` : ''}
              </div>
            `;
            isFirstPage = false;
          } else {
            pageDiv.innerHTML = `
              <div class="pdf-content" style="padding-top: 30px;"></div>
              <div class="pdf-footer">
                <div><strong>‡§™‡§Ç‡§°‡§ø‡§§:</strong> ${pandit.name} | <strong>‡§´‡•ã‡§®:</strong> ${pandit.phone}</div>
                <div><strong>‡§™‡§§‡§æ:</strong> ${pandit.address}</div>
                ${pandit.website ? `<div><strong>‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü:</strong> ${pandit.website}</div>` : ''}
              </div>
            `;
          }
          
          container.appendChild(pageDiv);
          pages.push(pageDiv);
          currentRowCount = 0;
          return pageDiv;
        };
        
        currentPage = createNewPage();
        
        groupedMaterials.forEach(group => {
          const contentDiv = currentPage.querySelector('.pdf-content');
          
          const heading = document.createElement('h3');
          heading.className = 'pdf-pooja-heading';
          heading.textContent = `üïâÔ∏è ${group.poojaName}`;
          contentDiv.appendChild(heading);
          
          const table = document.createElement('table');
          table.className = 'pdf-table';
          table.innerHTML = `
            <thead>
              <tr>
                <th>‡§∏‡§æ‡§Æ‡§æ‡§®</th>
                <th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>
                <th>‡§∏‡§æ‡§Æ‡§æ‡§®</th>
                <th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          contentDiv.appendChild(table);
          
          const tbody = table.querySelector('tbody');
          const pairs = this.chunkArray(group.items, 2);
          
          pairs.forEach(pair => {
            const currentMaxRows = pages.length === 1 ? this.PDF_CONFIG.FIRST_PAGE_ROWS : this.PDF_CONFIG.SUBSEQUENT_PAGE_ROWS;
            
            if (currentRowCount >= currentMaxRows) {
              currentPage = createNewPage();
              const newContentDiv = currentPage.querySelector('.pdf-content');
              
              const newHeading = document.createElement('h3');
              newHeading.className = 'pdf-pooja-heading';
              newHeading.textContent = `üïâÔ∏è ${group.poojaName} (‡§ú‡§æ‡§∞‡•Ä...)`;
              newContentDiv.appendChild(newHeading);
              
              const newTable = document.createElement('table');
              newTable.className = 'pdf-table';
              newTable.innerHTML = `
                <thead>
                  <tr>
                    <th>‡§∏‡§æ‡§Æ‡§æ‡§®</th>
                    <th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>
                    <th>‡§∏‡§æ‡§Æ‡§æ‡§®</th>
                    <th>‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ</th>
                  </tr>
                </thead>
                <tbody></tbody>
              `;
              newContentDiv.appendChild(newTable);
              tbody.parentElement.replaceWith(newTable);
              tbody.replaceWith(newTable.querySelector('tbody'));
            }
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${pair[0]?.name || ''}</td>
              <td>${pair[0] ? (pair[0].qty + ' ' + pair[0].unit).trim() : ''}</td>
              <td>${pair[1]?.name || ''}</td>
              <td>${pair[1] ? (pair[1].qty + ' ' + pair[1].unit).trim() : ''}</td>
            `;
            table.querySelector('tbody').appendChild(tr);
            currentRowCount++;
          });
        });
        
        return pages;
      },

      async downloadMultiPagePDF() {
        this.showLoading('Generating PDF...');

        try {
          const includedMaterials = this.state.materials.filter(m => m.included);
          const pages = this.createPDFPages(includedMaterials);
          
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');
          
          for (let i = 0; i < pages.length; i++) {
            if (i > 0) pdf.addPage();
            
            const canvas = await html2canvas(pages[i], {
              scale: 2,
              useCORS: true,
              backgroundColor: '#ffffff'
            });

            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            const imgWidth = 210;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
          }
          
          const filename = `${this.state.editableData.yajmanName || this.state.yajmanName || 'Pooja'}_Samagri_${Date.now()}.pdf`;
          pdf.save(filename);
          
          pages.forEach(page => page.remove());
          
          this.hideLoading();
          this.toast('‚úÖ PDF Downloaded', `${pages.length} pages`, 'success');
        } catch (error) {
          this.hideLoading();
          this.toast('‚ùå Failed', error.message, 'error');
          console.error(error);
        }
      },

      async downloadImagesZIP() {
        this.showLoading('Generating images...');

        try {
          const includedMaterials = this.state.materials.filter(m => m.included);
          const pages = this.createPDFPages(includedMaterials);
          
          const zip = new JSZip();
          const folder = zip.folder(`${this.state.editableData.yajmanName || this.state.yajmanName}_Samagri`);
          
          for (let i = 0; i < pages.length; i++) {
            const canvas = await html2canvas(pages[i], {
              scale: 2,
              useCORS: true,
              backgroundColor: '#ffffff'
            });

            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            folder.file(`Page_${i + 1}.png`, blob);
          }
          
          const zipBlob = await zip.generateAsync({ type: 'blob' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(zipBlob);
          link.download = `${this.state.editableData.yajmanName || this.state.yajmanName}_Samagri_${Date.now()}.zip`;
          link.click();
          
          pages.forEach(page => page.remove());
          
          this.hideLoading();
          this.toast('‚úÖ ZIP Downloaded', `${pages.length} images`, 'success');
        } catch (error) {
          this.hideLoading();
          this.toast('‚ùå Failed', error.message, 'error');
          console.error(error);
        }
      },

      chunkArray(array, size) {
        const chunks = [];
        for (let i = 0; i < array.length; i += size) {
          chunks.push(array.slice(i, i + size));
        }
        return chunks;
      },

      async shareWhatsApp() {
        this.showLoading('Preparing...');
        
        try {
          const includedMaterials = this.state.materials.filter(m => m.included);
          const pages = this.createPDFPages(includedMaterials);
          
          if (pages.length === 0) {
            this.toast('‚ö†Ô∏è Error', 'No content', 'error');
            return;
          }
          
          const canvas = await html2canvas(pages[0], {
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff'
          });
          
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
          const file = new File([blob], `Pooja_Samagri.png`, { type: 'image/png' });
          
          pages.forEach(page => page.remove());
          
          this.hideLoading();
          
          if (navigator.share) {
            await navigator.share({
              files: [file],
              title: '‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä',
              text: `${this.state.editableData.yajmanName || this.state.yajmanName} ‡§ï‡•Ä ‡§™‡•Ç‡§ú‡§æ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡•Ç‡§ö‡•Ä`
            });
            this.toast('‚úÖ Shared', 'Sent', 'success');
          } else {
            this.toast('‚ö†Ô∏è Not Supported', 'Download and share manually', 'warning');
          }
        } catch (error) {
          this.hideLoading();
          this.toast('‚ùå Failed', error.message, 'error');
        }
      },

      printDocument() {
        window.print();
      },

      updateStats() {
        const totalYajmans = this.state.templates.length;
        const uniquePoojas = [...new Set(this.state.masterData.map(x => x.pooja?.trim()))].filter(Boolean);
        
        document.getElementById('totalYajmans').textContent = totalYajmans;
        document.getElementById('totalPoojas').textContent = uniquePoojas.length;
        document.getElementById('totalItems').textContent = this.state.masterData.length;
        document.getElementById('cloudSaved').textContent = totalYajmans;
      },

      navigateTo(pageId) {
        document.querySelectorAll('.page-section').forEach(page => {
          page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-page="${pageId}"]`)?.classList.add('active');
        
        this.state.currentPage = pageId;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      },

      openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
      },

      closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
      },

      openSettings() {
        this.openModal('settingsModal');
      },

      toast(title, message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
          success: '‚úÖ',
          error: '‚ùå',
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è'
        };
        
        toast.innerHTML = `
          <div class="toast-icon">${icons[type]}</div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            ${message ? `<div class="toast-message">${message}</div>` : ''}
          </div>
        `;
        
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      },

      showLoading(text = 'Processing...') {
        document.getElementById('loadingText').textContent = text;
        document.getElementById('loadingOverlay').classList.add('active');
      },

      hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
      },

      saveState() {
        localStorage.setItem('vedicStudioState', JSON.stringify(this.state));
      },

      loadSavedState() {
        const saved = localStorage.getItem('vedicStudioState');
        if (saved) {
          try {
            const savedState = JSON.parse(saved);
            this.state = { ...this.state, ...savedState };
          } catch (error) {
            console.error('Failed to load state:', error);
          }
        }
      }
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => app.init());
    } else {
      app.init();
    }

    setInterval(() => app.saveState(), 30000);
  </script>

</body>
</html>