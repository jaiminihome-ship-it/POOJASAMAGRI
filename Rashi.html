<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Vedic Studio Pro v13 - Enhanced Edition</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Cinzel+Decorative:wght@700;900&family=Noto+Serif+Devanagari:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root { 
      --gold: #BF953F; 
      --gold-l: #FCF6BA; 
      --gold-d: #8B6914;
      --dark: #050505; 
      --panel: #0f172a;
      --card: #1e293b;
      --success: #10b981;
      --error: #ef4444;
      --info: #3b82f6;
      --sidebar-width: 380px;
      --header-height: 60px;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    body { 
      font-family: 'Outfit', sans-serif; 
      background: var(--dark); 
      color: white; 
      display: flex; 
      height: 100vh;
      height: 100dvh;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--dark); }
    ::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 3px; }

    /* ============ MOBILE HEADER ============ */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background: linear-gradient(135deg, var(--gold-d), var(--gold));
      z-index: 1000;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.5);
    }
    
    .mobile-header h1 {
      font-family: 'Cinzel Decorative';
      color: #000;
      font-size: 18px;
    }
    
    .menu-toggle {
      width: 44px;
      height: 44px;
      background: rgba(0,0,0,0.2);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: all 0.3s;
    }
    
    .menu-toggle span {
      width: 24px;
      height: 3px;
      background: #000;
      border-radius: 2px;
      transition: all 0.3s;
    }
    
    .menu-toggle.active span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    
    .menu-toggle.active span:nth-child(2) {
      opacity: 0;
    }
    
    .menu-toggle.active span:nth-child(3) {
      transform: rotate(-45deg) translate(6px, -6px);
    }

    /* ============ SIDEBAR ============ */
    .sidebar { 
      width: var(--sidebar-width); 
      min-width: var(--sidebar-width); 
      background: var(--panel); 
      border-right: 2px solid var(--gold); 
      display: flex; 
      flex-direction: column; 
      z-index: 100;
      transition: transform 0.3s ease;
    }
    
    .sidebar-header {
      background: linear-gradient(135deg, var(--gold-d), var(--gold));
      padding: 20px;
      text-align: center;
      flex-shrink: 0;
    }
    
    .sidebar-header h1 {
      font-family: 'Cinzel Decorative';
      color: #000;
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .sidebar-header p {
      color: #000;
      opacity: 0.8;
      font-size: 12px;
    }
    
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      -webkit-overflow-scrolling: touch;
    }

    /* Overlay for mobile */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 99;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .sidebar-overlay.active {
      opacity: 1;
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      background: var(--card);
      border-radius: 10px;
      border-left: 4px solid var(--gold);
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .status-dot.loading { background: #f59e0b; animation: pulse 1s infinite; }
    .status-dot.ready { background: var(--success); }
    .status-dot.error { background: var(--error); }
    
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* Form Groups */
    .group { 
      background: var(--card); 
      padding: 15px; 
      border-radius: 12px; 
    }
    
    .group-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 10px;
      letter-spacing: 1.5px;
      font-weight: 600;
    }
    
    select, input[type="text"], input[type="date"], textarea { 
      width: 100%; 
      background: #000; 
      border: 1px solid #374151; 
      color: white; 
      padding: 12px 15px; 
      border-radius: 8px; 
      font-family: inherit; 
      font-size: 16px;
      transition: border-color 0.3s, box-shadow 0.3s;
      -webkit-appearance: none;
      appearance: none;
    }
    
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23BF953F' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      padding-right: 40px;
    }
    
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 3px rgba(191, 149, 63, 0.2);
    }
    
    textarea { 
      resize: vertical; 
      min-height: 80px;
      font-family: 'Noto Serif Devanagari', serif;
    }

    /* Pandit Selector Special Styling */
    .pandit-selector {
      background: linear-gradient(135deg, var(--gold-d), var(--gold));
      border: none;
      color: #000;
      font-weight: 600;
    }
    
    .pandit-info {
      margin-top: 10px;
      padding: 10px;
      background: rgba(191, 149, 63, 0.1);
      border-radius: 8px;
      border: 1px solid var(--gold);
      font-size: 12px;
    }
    
    .pandit-info .name {
      color: var(--gold);
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .pandit-info .detail {
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    /* Theme Grid */
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    
    .theme-chip {
      aspect-ratio: 1;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .theme-chip:hover {
      transform: scale(1.1);
      z-index: 1;
    }
    
    .theme-chip.active {
      border-color: white;
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
    
    .theme-chip::after {
      content: attr(data-name);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      font-size: 8px;
      padding: 2px;
      text-align: center;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .theme-chip:hover::after {
      opacity: 1;
    }

    /* Range Slider */
    .range-group {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    input[type="range"] {
      flex: 1;
      -webkit-appearance: none;
      height: 8px;
      background: #374151;
      border-radius: 4px;
      outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--gold), var(--gold-l));
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .range-value {
      background: var(--gold);
      color: #000;
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 800;
      font-size: 13px;
      min-width: 55px;
      text-align: center;
    }

    /* Rashi List */
    .rashi-list { 
      max-height: 300px; 
      overflow-y: auto; 
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-right: 5px;
      -webkit-overflow-scrolling: touch;
    }
    
    .r-item { 
      background: #000; 
      padding: 12px; 
      border-radius: 10px;
      border: 1px solid #374151;
      transition: border-color 0.3s;
    }
    
    .r-item:focus-within {
      border-color: var(--gold);
    }
    
    .r-item-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .r-item-header label {
      font-weight: 600;
      color: var(--gold);
      font-size: 14px;
    }
    
    .r-item-header span {
      font-size: 11px;
      color: #6b7280;
    }
    
    .r-item textarea {
      font-size: 14px;
      min-height: 60px;
    }

    /* Quick Actions Row */
    .quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .quick-btn {
      padding: 12px 10px;
      border: 1px solid #374151;
      background: transparent;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      min-height: 44px;
    }
    
    .quick-btn:hover, .quick-btn:active {
      border-color: var(--gold);
      background: rgba(191, 149, 63, 0.1);
    }

    /* Download Buttons */
    .download-section {
      background: var(--card);
      padding: 15px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .btn { 
      width: 100%; 
      padding: 14px 20px; 
      border: none; 
      border-radius: 10px; 
      cursor: pointer; 
      font-weight: 700; 
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
      min-height: 50px;
    }
    
    .btn:disabled { 
      opacity: 0.5; 
      cursor: not-allowed; 
      transform: none !important;
    }
    
    .btn:not(:disabled):hover,
    .btn:not(:disabled):active {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }
    
    .btn:not(:disabled):active {
      transform: translateY(0);
    }
    
    .btn-png { 
      background: linear-gradient(135deg, var(--gold), var(--gold-l)); 
      color: #000; 
    }
    
    .btn-zip { 
      background: linear-gradient(135deg, #0891b2, #22d3ee); 
      color: #000; 
    }
    
    .btn-pdf { 
      background: linear-gradient(135deg, #dc2626, #f87171); 
      color: white; 
    }
    
    .btn-copy {
      background: linear-gradient(135deg, #7c3aed, #a78bfa);
      color: white;
    }

    /* Progress Bar */
    .progress-container {
      display: none;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      height: 8px;
    }
    
    .progress-container.active { display: block; }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), var(--gold-l));
      width: 0%;
      transition: width 0.3s;
    }

    /* Log Messages */
    .log-area {
      font-size: 12px;
      text-align: center;
      min-height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .log-area.success { color: var(--success); }
    .log-area.error { color: var(--error); }
    .log-area.info { color: var(--info); }
    .log-area .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ============ PREVIEW WORKSPACE ============ */
    .view { 
      flex: 1; 
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      padding: 30px;
      position: relative;
      overflow: hidden;
      min-width: 0;
    }
    
    /* Decorative Background */
    .view::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at center, rgba(191, 149, 63, 0.03) 0%, transparent 50%);
      animation: rotate 60s linear infinite;
      pointer-events: none;
    }
    
    @keyframes rotate { to { transform: rotate(360deg); } }
    
    .canvas-container {
      position: relative;
      width: 100%;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .canvas-frame { 
      position: relative;
      box-shadow: 0 25px 80px rgba(0,0,0,0.8), 0 0 0 1px rgba(191, 149, 63, 0.3);
      border-radius: 8px; 
      overflow: hidden;
      max-height: 100%;
      max-width: 100%;
      touch-action: pinch-zoom pan-x pan-y;
    }
    
    canvas { 
      display: block;
      max-width: 100%; 
      max-height: 100%;
      object-fit: contain;
    }

    /* Navigation */
    .nav { 
      margin-top: 20px; 
      display: flex; 
      align-items: center; 
      gap: 15px; 
      background: var(--panel); 
      padding: 12px 25px; 
      border-radius: 50px; 
      border: 2px solid var(--gold);
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      flex-shrink: 0;
    }
    
    .nav-btn { 
      background: transparent;
      border: 2px solid var(--gold);
      color: var(--gold); 
      width: 48px;
      height: 48px;
      border-radius: 50%;
      font-size: 20px; 
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .nav-btn:hover, .nav-btn:active {
      background: var(--gold);
      color: #000;
    }
    
    .nav-label {
      min-width: 120px;
      text-align: center;
      font-weight: 700;
      font-size: 16px;
    }
    
    .nav-label small {
      display: block;
      font-size: 11px;
      color: var(--gold);
      margin-top: 2px;
    }

    /* Keyboard Shortcuts Hint */
    .shortcuts-hint {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 11px;
      color: #6b7280;
    }
    
    .shortcuts-hint kbd {
      background: #374151;
      padding: 2px 6px;
      border-radius: 4px;
      margin: 0 2px;
    }

    /* Date Display */
    .date-display {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.7);
      padding: 12px 18px;
      border-radius: 10px;
      border: 1px solid var(--gold);
      z-index: 10;
    }
    
    .date-display .date {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold);
    }
    
    .date-display .day {
      font-size: 12px;
      color: #9ca3af;
    }

    /* Current Pandit Indicator */
    .current-pandit {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      padding: 10px 15px;
      border-radius: 10px;
      border: 1px solid var(--gold);
      z-index: 10;
      text-align: right;
    }
    
    .current-pandit .label {
      font-size: 10px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .current-pandit .name {
      font-size: 14px;
      font-weight: 700;
      color: var(--gold);
      margin-top: 2px;
    }

    /* Utility Classes */
    .hidden { display: none !important; }
    
    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: calc(100vw - 40px);
    }
    
    .toast {
      background: var(--panel);
      border: 1px solid var(--gold);
      padding: 12px 16px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      font-size: 14px;
    }
    
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--error); }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Swipe Indicator (Mobile) */
    .swipe-hint {
      display: none;
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      color: var(--gold);
      animation: fadeInOut 3s ease forwards;
    }
    
    @keyframes fadeInOut {
      0%, 100% { opacity: 0; }
      20%, 80% { opacity: 1; }
    }

    /* ============ TABLET STYLES ============ */
    @media (max-width: 1024px) {
      :root {
        --sidebar-width: 340px;
      }
      
      .view {
        padding: 20px;
      }
      
      .current-pandit {
        display: none;
      }
      
      .theme-grid {
        grid-template-columns: repeat(5, 1fr);
      }
    }

    /* ============ MOBILE STYLES ============ */
    @media (max-width: 768px) {
      :root {
        --sidebar-width: 100%;
        --header-height: 56px;
      }
      
      body {
        flex-direction: column;
      }
      
      .mobile-header {
        display: flex;
      }
      
      .sidebar {
        position: fixed;
        top: var(--header-height);
        left: 0;
        bottom: 0;
        width: 85%;
        max-width: 360px;
        transform: translateX(-100%);
        z-index: 100;
        border-right: 2px solid var(--gold);
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .sidebar-header {
        display: none;
      }
      
      .sidebar-overlay {
        display: block;
        pointer-events: none;
      }
      
      .sidebar-overlay.active {
        pointer-events: auto;
      }
      
      .view {
        margin-top: var(--header-height);
        height: calc(100vh - var(--header-height));
        height: calc(100dvh - var(--header-height));
        padding: 15px;
        padding-bottom: 20px;
      }
      
      .date-display {
        top: 10px;
        left: 10px;
        padding: 8px 12px;
      }
      
      .date-display .date {
        font-size: 14px;
      }
      
      .date-display .day {
        font-size: 10px;
      }
      
      .current-pandit {
        display: none;
      }
      
      .canvas-container {
        margin-bottom: 10px;
      }
      
      .nav {
        margin-top: 10px;
        padding: 10px 20px;
        gap: 12px;
      }
      
      .nav-btn {
        width: 44px;
        height: 44px;
        font-size: 18px;
      }
      
      .nav-label {
        min-width: 100px;
        font-size: 14px;
      }
      
      .shortcuts-hint {
        display: none;
      }
      
      .swipe-hint {
        display: block;
      }
      
      .toast-container {
        top: calc(var(--header-height) + 10px);
        right: 10px;
        left: 10px;
      }
      
      .toast {
        font-size: 13px;
        padding: 10px 14px;
      }
      
      .group {
        padding: 12px;
      }
      
      .rashi-list {
        max-height: 250px;
      }
      
      .download-section .btn {
        padding: 12px 15px;
        font-size: 13px;
        min-height: 48px;
      }
      
      .download-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      
      .download-grid .btn-png {
        grid-column: 1 / -1;
      }
      
      .theme-grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    /* ============ SMALL MOBILE STYLES ============ */
    @media (max-width: 400px) {
      .sidebar {
        width: 100%;
        max-width: 100%;
      }
      
      .nav {
        padding: 8px 15px;
        gap: 8px;
        border-radius: 30px;
      }
      
      .nav-btn {
        width: 40px;
        height: 40px;
        font-size: 16px;
      }
      
      .nav-label {
        min-width: 80px;
        font-size: 13px;
      }
      
      .date-display {
        padding: 6px 10px;
      }
      
      .date-display .date {
        font-size: 12px;
      }
      
      .theme-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* ============ LANDSCAPE MOBILE ============ */
    @media (max-width: 768px) and (orientation: landscape) {
      .view {
        padding: 10px;
        flex-direction: row;
        gap: 15px;
      }
      
      .canvas-container {
        flex: 1;
        margin-bottom: 0;
      }
      
      .nav {
        flex-direction: column;
        padding: 15px 10px;
        border-radius: 25px;
        margin-top: 0;
        gap: 8px;
      }
      
      .nav-btn {
        width: 40px;
        height: 40px;
      }
      
      .nav-label {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        transform: rotate(180deg);
        min-width: unset;
      }
      
      .date-display {
        top: 5px;
        left: 5px;
      }
    }

    /* Print Styles */
    @media print {
      body * { visibility: hidden; }
      .canvas-frame, .canvas-frame * { visibility: visible; }
      .canvas-frame { 
        position: fixed; 
        left: 50%; 
        top: 50%; 
        transform: translate(-50%, -50%);
        box-shadow: none;
        max-width: 100%;
        max-height: 100%;
      }
    }

    /* High DPI adjustments */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      .canvas-frame {
        image-rendering: -webkit-optimize-contrast;
      }
    }
  </style>
</head>
<body>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Mobile Header -->
<header class="mobile-header">
  <h1>‚öúÔ∏è Vedic Studio</h1>
  <button class="menu-toggle" id="menuToggle" aria-label="Toggle Menu">
    <span></span>
    <span></span>
    <span></span>
  </button>
</header>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h1>‚öúÔ∏è Vedic Studio</h1>
    <p>Designed By Niranjan</p>
  </div>
  
  <div class="sidebar-content">
    <!-- Status -->
    <div class="status-bar">
      <div id="statusDot" class="status-dot loading"></div>
      <span id="statusText">‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</span>
    </div>
    
    <!-- PANDIT SELECTOR -->
    <div class="group">
      <div class="group-title">üôè ‡§™‡§Ç‡§°‡§ø‡§§ ‡§ú‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç</div>
      <select id="panditSelect" class="pandit-selector" onchange="vs.onPanditChange()">
        <option value="yugal">‡§™‡§Ç. ‡§Ø‡•Å‡§ó‡§≤ ‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø</option>
        <option value="purushottam">‡§™‡§Ç. ‡§™‡•Å‡§∞‡•Å‡§∑‡•ã‡§§‡•ç‡§§‡§Æ ‡§∂‡§∞‡•ç‡§Æ‡§æ</option>
      </select>
      <div class="pandit-info" id="panditInfo">
        <div class="name" id="panditInfoName">‡§™‡§Ç. ‡§Ø‡•Å‡§ó‡§≤ ‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø</div>
        <div class="detail" id="panditInfoTitle">üìø ‡§µ‡•à‡§¶‡§ø‡§ï ‡§ú‡•ç‡§Ø‡•ã‡§§‡§ø‡§∑‡§æ‡§ö‡§æ‡§∞‡•ç‡§Ø</div>
        <div class="detail" id="panditInfoPhone">üìû +91 9928139485</div>
        <div class="detail" id="panditInfoAddress">üåê astroyugalacharya.in</div>
      </div>
    </div>
    
    <!-- Design Mode -->
    <div class="group">
      <div class="group-title">üìê ‡§°‡§ø‡§ú‡§º‡§æ‡§á‡§® ‡§Æ‡•ã‡§°</div>
      <select id="mode" onchange="vs.sync()">
        <option value="rashi">üìä ‡§¶‡•à‡§®‡§ø‡§ï ‡§∞‡§æ‡§∂‡§ø‡§´‡§≤ (12 Images)</option>
        <option value="alert">üì¢ ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∏‡•Ç‡§ö‡§®‡§æ (Single)</option>
        <option value="panchang">üìÖ ‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó (Daily)</option>
        <option value="letterhead">üìÑ ‡§≤‡•á‡§ü‡§∞‡§π‡•á‡§° (A4)</option>
      </select>
    </div>

    <!-- üÜï ENHANCED THEME SELECTOR -->
    <div class="group">
      <div class="group-title">üé® ‡§™‡•ç‡§∞‡•Ä‡§Æ‡§ø‡§Ø‡§Æ ‡§•‡•Ä‡§Æ (12 ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™)</div>
      <select id="th" onchange="vs.onThemeChange()">
        <optgroup label="üåü ‡§ï‡•ç‡§≤‡§æ‡§∏‡§ø‡§ï ‡§•‡•Ä‡§Æ‡•ç‡§∏">
          <option value="saumya">ü§ç ‡§∏‡•å‡§Æ‡•ç‡§Ø (Royal White)</option>
          <option value="dharma">üß° ‡§ß‡§∞‡•ç‡§Æ (Sacred Copper)</option>
          <option value="akash">üñ§ ‡§Ü‡§ï‡§æ‡§∂ (Celestial Dark)</option>
        </optgroup>
        <optgroup label="üíé ‡§∞‡§§‡•ç‡§® ‡§•‡•Ä‡§Æ‡•ç‡§∏">
          <option value="ratna">üíô ‡§®‡•Ä‡§≤‡§Æ (Sapphire Blue)</option>
          <option value="panna">üíö ‡§™‡§®‡•ç‡§®‡§æ (Emerald Green)</option>
          <option value="manik">‚ù§Ô∏è ‡§Æ‡§æ‡§£‡§ø‡§ï (Ruby Red)</option>
        </optgroup>
        <optgroup label="üå∏ ‡§®‡•á‡§ö‡§∞ ‡§•‡•Ä‡§Æ‡•ç‡§∏">
          <option value="pushp">üå∏ ‡§™‡•Å‡§∑‡•ç‡§™ (Lotus Pink)</option>
          <option value="kesari">üß° ‡§ï‡•á‡§∏‡§∞‡•Ä (Saffron)</option>
          <option value="chandni">üåô ‡§ö‡§æ‡§Ç‡§¶‡§®‡•Ä (Moonlight)</option>
        </optgroup>
        <optgroup label="‚ú® ‡§™‡•ç‡§∞‡•Ä‡§Æ‡§ø‡§Ø‡§Æ ‡§•‡•Ä‡§Æ‡•ç‡§∏">
          <option value="sandhya">üåÖ ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ (Sunset)</option>
          <option value="samudra">üåä ‡§∏‡§Æ‡•Å‡§¶‡•ç‡§∞ (Ocean)</option>
          <option value="vaibhav">üëë ‡§µ‡•à‡§≠‡§µ (Royal Gold)</option>
        </optgroup>
      </select>
      
      <!-- Visual Theme Chips -->
      <div class="theme-grid" id="themeGrid"></div>
    </div>

    <!-- Font Size -->
    <div class="group">
      <div class="group-title">üî§ ‡§´‡•â‡§®‡•ç‡§ü ‡§∏‡§æ‡§á‡§ú‡§º</div>
      <div class="range-group">
        <input type="range" id="fs" min="28" max="80" value="42" oninput="vs.draw()">
        <span class="range-value" id="fv">42px</span>
      </div>
    </div>

    <!-- Date Selection -->
    <div class="group">
      <div class="group-title">üìÖ ‡§§‡§ø‡§•‡§ø</div>
      <input type="date" id="postDate" onchange="vs.draw()">
    </div>

    <!-- Rashi Inputs -->
    <div id="rashiBox" class="group">
      <div class="group-title">üîØ ‡§∞‡§æ‡§∂‡§ø‡§´‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü</div>
      <div class="quick-actions" style="margin-bottom: 12px;">
        <button class="quick-btn" onclick="vs.clearAll()">üóëÔ∏è ‡§∏‡§¨ ‡§Æ‡§ø‡§ü‡§æ‡§è‡§Ç</button>
        <button class="quick-btn" onclick="vs.fillSample()">üìù ‡§∏‡•à‡§Ç‡§™‡§≤ ‡§≠‡§∞‡•á‡§Ç</button>
      </div>
      <div class="rashi-list" id="rashiList"></div>
    </div>

    <!-- Single Edit Box -->
    <div id="editBox" class="group hidden">
      <div class="group-title" id="editTitle">‚úèÔ∏è ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§è‡§°‡§ø‡§ü‡§∞</div>
      <input type="text" id="mainH" placeholder="‡§π‡•á‡§°‡§ø‡§Ç‡§ó ‡§≤‡§ø‡§ñ‡•á‡§Ç..." oninput="vs.draw()" style="margin-bottom: 10px; font-weight: 600;">
      <textarea id="mainB" rows="6" placeholder="‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•á‡§Ç..." oninput="vs.draw()"></textarea>
    </div>

    <!-- Download Section -->
    <div class="download-section">
      <div class="group-title">üíæ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™</div>
      
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      
      <div class="download-grid">
        <button class="btn btn-png" id="btnPng" onclick="vs.downloadPNG()">
          <span>üñºÔ∏è</span> PNG ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°
        </button>
        
        <button class="btn btn-zip" id="btnZip" onclick="vs.downloadZIP()">
          <span>üì¶</span> ZIP ‡§¨‡•à‡§ö
        </button>
        
        <button class="btn btn-pdf" id="btnPdf" onclick="vs.downloadPDF()">
          <span>üìÑ</span> PDF
        </button>
        
        <button class="btn btn-copy" onclick="vs.copyToClipboard()">
          <span>üìã</span> ‡§ï‡•â‡§™‡•Ä
        </button>
      </div>
      
      <div class="log-area" id="logArea"></div>
    </div>
  </div>
</aside>

<!-- Main View -->
<main class="view">
  <div class="date-display">
    <div class="date" id="todayDate"></div>
    <div class="day" id="todayDay"></div>
  </div>
  
  <div class="current-pandit">
    <div class="label">‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§™‡§Ç‡§°‡§ø‡§§</div>
    <div class="name" id="currentPanditName">‡§™‡§Ç. ‡§Ø‡•Å‡§ó‡§≤ ‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø</div>
  </div>
  
  <div class="canvas-container" id="canvasContainer">
    <div class="canvas-frame">
      <canvas id="canvas"></canvas>
    </div>
  </div>
  
  <nav id="navPanel" class="nav">
    <button class="nav-btn" onclick="vs.slide(-1)" aria-label="Previous">‚óÄ</button>
    <div class="nav-label">
      <span id="navName">‡§Æ‡•á‡§∑</span>
      <small id="navCount">1 / 12</small>
    </div>
    <button class="nav-btn" onclick="vs.slide(1)" aria-label="Next">‚ñ∂</button>
  </nav>
  
  <div class="shortcuts-hint">
    <kbd>‚Üê</kbd> <kbd>‚Üí</kbd> Navigate &nbsp;|&nbsp; 
    <kbd>Ctrl</kbd>+<kbd>S</kbd> Save PNG
  </div>
  
  <div class="swipe-hint" id="swipeHint">
    üëÜ ‡§∏‡•ç‡§µ‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç ‡§∞‡§æ‡§∂‡§ø ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
  </div>
</main>

<script>
// =====================================================
// VEDIC STUDIO PRO v13 - Enhanced Edition
// =====================================================

const vs = {
  // Canvas & Context
  can: document.getElementById('canvas'),
  ctx: null,
  
  // QR Code Image
  qrImage: null,
  qrLoaded: false,
  
  // Mobile State
  isMobile: false,
  touchStartX: 0,
  touchStartY: 0,
  
  // PANDIT DATA
  pandits: {
    yugal: {
      id: 'yugal',
      name: '‡§™‡§Ç. ‡§Ø‡•Å‡§ó‡§≤ ‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø',
      nameShort: '‡§Ø‡•Å‡§ó‡§≤ ‡§Ü‡§ö‡§æ‡§∞‡•ç‡§Ø',
      title: '‡§µ‡•à‡§¶‡§ø‡§ï ‡§ú‡•ç‡§Ø‡•ã‡§§‡§ø‡§∑‡§æ‡§ö‡§æ‡§∞‡•ç‡§Ø ‡§è‡§µ‡§Ç ‡§µ‡§æ‡§∏‡•ç‡§§‡•Å ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û',
      titleShort: '‡§µ‡•à‡§¶‡§ø‡§ï ‡§ú‡•ç‡§Ø‡•ã‡§§‡§ø‡§∑‡§æ‡§ö‡§æ‡§∞‡•ç‡§Ø',
      phone: '+91 9928139485',
      phoneDisplay: 'üìû +91 9928139485',
      website: 'www.astroyugalacharya.in',
      websiteDisplay: 'üåê www.astroyugalacharya.in',
      address: '‡§ú‡§Ø‡§™‡•Å‡§∞, ‡§∞‡§æ‡§ú‡§∏‡•ç‡§•‡§æ‡§®',
      addressDisplay: 'üìç ‡§ú‡§Ø‡§™‡•Å‡§∞, ‡§∞‡§æ‡§ú‡§∏‡•ç‡§•‡§æ‡§®',
      handle: '@astroyugalacharya',
      handleDisplay: 'astroyugalacharya.in',
      socials: 'üì± WhatsApp | üì∑ Instagram | üìò Facebook',
      hasQR: true, // üÜï QR Code enabled
      qrUrl: 'https://jaiminihome-ship-it.github.io/POOJASAMAGRI/qr.png'
    },
    purushottam: {
      id: 'purushottam',
      name: '‡§™‡§Ç. ‡§™‡•Å‡§∞‡•Å‡§∑‡•ã‡§§‡•ç‡§§‡§Æ ‡§∂‡§∞‡•ç‡§Æ‡§æ',
      nameShort: '‡§™‡•Å‡§∞‡•Å‡§∑‡•ã‡§§‡•ç‡§§‡§Æ ‡§∂‡§∞‡•ç‡§Æ‡§æ',
      title: '‡§ú‡•ç‡§Ø‡•ã‡§§‡§ø‡§∑‡§æ‡§ö‡§æ‡§∞‡•ç‡§Ø',
      titleShort: '‡§ú‡•ç‡§Ø‡•ã‡§§‡§ø‡§∑‡§æ‡§ö‡§æ‡§∞‡•ç‡§Ø',
      phone: '+91 9680992496',
      phoneDisplay: 'üìû +91 9680992496',
      website: '',
      websiteDisplay: '',
      address: '‡§∂‡•ç‡§∞‡•Ä ‡§∞‡§æ‡§Æ ‡§Æ‡§Ç‡§¶‡§ø‡§∞, ‡§ó‡§ø‡§∞‡§®‡§æ‡§∞ ‡§ï‡•â‡§≤‡•ã‡§®‡•Ä, ‡§µ‡•à‡§∂‡§æ‡§≤‡•Ä ‡§®‡§ó‡§∞, ‡§ú‡§Ø‡§™‡•Å‡§∞',
      addressDisplay: 'üìç ‡§∂‡•ç‡§∞‡•Ä ‡§∞‡§æ‡§Æ ‡§Æ‡§Ç‡§¶‡§ø‡§∞, ‡§ó‡§ø‡§∞‡§®‡§æ‡§∞ ‡§ï‡•â‡§≤‡•ã‡§®‡•Ä, ‡§µ‡•à‡§∂‡§æ‡§≤‡•Ä ‡§®‡§ó‡§∞, ‡§ú‡§Ø‡§™‡•Å‡§∞',
      addressShort: '‡§µ‡•à‡§∂‡§æ‡§≤‡•Ä ‡§®‡§ó‡§∞, ‡§ú‡§Ø‡§™‡•Å‡§∞',
      handle: '',
      handleDisplay: '‡§µ‡•à‡§∂‡§æ‡§≤‡•Ä ‡§®‡§ó‡§∞, ‡§ú‡§Ø‡§™‡•Å‡§∞',
      socials: 'üì± WhatsApp ‡§™‡§∞ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç',
      hasQR: false, // üÜï No QR Code for Purushottam
      qrUrl: ''
    }
  },
  
  // Current Selected Pandit
  currentPandit: 'yugal',
  
  // Rashi Names with Symbols
  rashis: [
    { name: "‡§Æ‡•á‡§∑", symbol: "‚ôà", en: "Aries" },
    { name: "‡§µ‡•É‡§∑", symbol: "‚ôâ", en: "Taurus" },
    { name: "‡§Æ‡§ø‡§•‡•Å‡§®", symbol: "‚ôä", en: "Gemini" },
    { name: "‡§ï‡§∞‡•ç‡§ï", symbol: "‚ôã", en: "Cancer" },
    { name: "‡§∏‡§ø‡§Ç‡§π", symbol: "‚ôå", en: "Leo" },
    { name: "‡§ï‡§®‡•ç‡§Ø‡§æ", symbol: "‚ôç", en: "Virgo" },
    { name: "‡§§‡•Å‡§≤‡§æ", symbol: "‚ôé", en: "Libra" },
    { name: "‡§µ‡•É‡§∂‡•ç‡§ö‡§ø‡§ï", symbol: "‚ôè", en: "Scorpio" },
    { name: "‡§ß‡§®‡•Å", symbol: "‚ôê", en: "Sagittarius" },
    { name: "‡§Æ‡§ï‡§∞", symbol: "‚ôë", en: "Capricorn" },
    { name: "‡§ï‡•Å‡§Ç‡§≠", symbol: "‚ôí", en: "Aquarius" },
    { name: "‡§Æ‡•Ä‡§®", symbol: "‚ôì", en: "Pisces" }
  ],
  
  // Current State
  currentIdx: 0,
  isReady: false,
  
  // üÜï ENHANCED THEMES (12 Beautiful Themes)
  themes: {
    // Classic Themes
    saumya: { 
      name: '‡§∏‡•å‡§Æ‡•ç‡§Ø',
      bg: '#fffaf4', 
      bgGrad: ['#fffaf4', '#fff5e6'],
      txt: '#2d3436', 
      acc: '#BF953F', 
      acc2: '#d4af37',
      bdr: '#d4af37',
      footer: '#f5f0e8',
      chip: 'linear-gradient(135deg, #fffaf4, #d4af37)'
    },
    dharma: { 
      name: '‡§ß‡§∞‡•ç‡§Æ',
      bg: '#fff9f0', 
      bgGrad: ['#fff9f0', '#ffedd5'],
      txt: '#5c3a1a', 
      acc: '#b45309', 
      acc2: '#d97706',
      bdr: '#f59e0b',
      footer: '#fef3c7',
      chip: 'linear-gradient(135deg, #fff9f0, #f59e0b)'
    },
    akash: { 
      name: '‡§Ü‡§ï‡§æ‡§∂',
      bg: '#0a0a0f', 
      bgGrad: ['#0a0a0f', '#1a1a2e'],
      txt: '#e5e7eb', 
      acc: '#FCF6BA', 
      acc2: '#BF953F',
      bdr: '#BF953F',
      footer: '#111827',
      chip: 'linear-gradient(135deg, #1a1a2e, #BF953F)'
    },
    
    // Gemstone Themes
    ratna: {
      name: '‡§®‡•Ä‡§≤‡§Æ',
      bg: '#0f172a',
      bgGrad: ['#0f172a', '#1e3a5f'],
      txt: '#e0f2fe',
      acc: '#38bdf8',
      acc2: '#0ea5e9',
      bdr: '#0284c7',
      footer: '#0c4a6e',
      chip: 'linear-gradient(135deg, #1e3a5f, #38bdf8)'
    },
    panna: {
      name: '‡§™‡§®‡•ç‡§®‡§æ',
      bg: '#022c22',
      bgGrad: ['#022c22', '#064e3b'],
      txt: '#d1fae5',
      acc: '#34d399',
      acc2: '#10b981',
      bdr: '#059669',
      footer: '#065f46',
      chip: 'linear-gradient(135deg, #064e3b, #34d399)'
    },
    manik: {
      name: '‡§Æ‡§æ‡§£‡§ø‡§ï',
      bg: '#1c1917',
      bgGrad: ['#1c1917', '#44403c'],
      txt: '#fef2f2',
      acc: '#f87171',
      acc2: '#ef4444',
      bdr: '#dc2626',
      footer: '#292524',
      chip: 'linear-gradient(135deg, #44403c, #f87171)'
    },
    
    // Nature Themes
    pushp: {
      name: '‡§™‡•Å‡§∑‡•ç‡§™',
      bg: '#fdf2f8',
      bgGrad: ['#fdf2f8', '#fce7f3'],
      txt: '#831843',
      acc: '#db2777',
      acc2: '#ec4899',
      bdr: '#f472b6',
      footer: '#fbcfe8',
      chip: 'linear-gradient(135deg, #fce7f3, #db2777)'
    },
    kesari: {
      name: '‡§ï‡•á‡§∏‡§∞‡•Ä',
      bg: '#fff7ed',
      bgGrad: ['#fff7ed', '#ffedd5'],
      txt: '#7c2d12',
      acc: '#ea580c',
      acc2: '#f97316',
      bdr: '#fb923c',
      footer: '#fed7aa',
      chip: 'linear-gradient(135deg, #ffedd5, #ea580c)'
    },
    chandni: {
      name: '‡§ö‡§æ‡§Ç‡§¶‡§®‡•Ä',
      bg: '#f8fafc',
      bgGrad: ['#f8fafc', '#e2e8f0'],
      txt: '#1e293b',
      acc: '#64748b',
      acc2: '#94a3b8',
      bdr: '#cbd5e1',
      footer: '#e2e8f0',
      chip: 'linear-gradient(135deg, #e2e8f0, #64748b)'
    },
    
    // Premium Themes
    sandhya: {
      name: '‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ',
      bg: '#1a1a2e',
      bgGrad: ['#16213e', '#1a1a2e', '#0f0f23'],
      txt: '#fef3c7',
      acc: '#f59e0b',
      acc2: '#d97706',
      bdr: '#b45309',
      footer: '#1e1e3f',
      gradientStops: [0, 0.5, 1],
      chip: 'linear-gradient(135deg, #f59e0b, #ef4444, #8b5cf6)'
    },
    samudra: {
      name: '‡§∏‡§Æ‡•Å‡§¶‡•ç‡§∞',
      bg: '#0c1929',
      bgGrad: ['#0c1929', '#164e63', '#0e7490'],
      txt: '#ecfeff',
      acc: '#22d3ee',
      acc2: '#06b6d4',
      bdr: '#0891b2',
      footer: '#083344',
      gradientStops: [0, 0.6, 1],
      chip: 'linear-gradient(135deg, #0c1929, #22d3ee)'
    },
    vaibhav: {
      name: '‡§µ‡•à‡§≠‡§µ',
      bg: '#1a1207',
      bgGrad: ['#1a1207', '#2d1f0a', '#3d2a0d'],
      txt: '#fef3c7',
      acc: '#fbbf24',
      acc2: '#f59e0b',
      bdr: '#d97706',
      footer: '#2d1f0a',
      gradientStops: [0, 0.5, 1],
      chip: 'linear-gradient(135deg, #fbbf24, #f59e0b, #b45309)'
    }
  },
  
  // ============ GET CURRENT PANDIT ============
  getPandit() {
    return this.pandits[this.currentPandit];
  },
  
  // ============ PANDIT CHANGE HANDLER ============
  onPanditChange() {
    const select = document.getElementById('panditSelect');
    this.currentPandit = select.value;
    const pandit = this.getPandit();
    
    // Update info panel
    document.getElementById('panditInfoName').textContent = pandit.name;
    document.getElementById('panditInfoTitle').textContent = 'üìø ' + pandit.title;
    document.getElementById('panditInfoPhone').textContent = pandit.phoneDisplay;
    
    if (pandit.website) {
      document.getElementById('panditInfoAddress').textContent = 'üåê ' + pandit.website;
    } else {
      document.getElementById('panditInfoAddress').textContent = pandit.addressDisplay;
    }
    
    // Update current pandit display in view
    document.getElementById('currentPanditName').textContent = pandit.name;
    
    // Reload QR if needed
    if (pandit.hasQR && pandit.qrUrl) {
      this.loadQRCode();
    }
    
    // Redraw canvas
    this.draw();
    
    // Save preference
    this.saveData();
    
    this.toast(`${pandit.name} ‡§ö‡•Å‡§®‡•á ‡§ó‡§è`, 'success');
  },
  
  // üÜï Theme change handler
  onThemeChange() {
    const themeName = document.getElementById('th').value;
    this.updateThemeChips(themeName);
    this.draw();
  },
  
  // üÜï Build theme chips
  buildThemeChips() {
    const grid = document.getElementById('themeGrid');
    grid.innerHTML = Object.entries(this.themes).map(([key, theme]) => `
      <div class="theme-chip ${key === 'saumya' ? 'active' : ''}" 
           data-theme="${key}" 
           data-name="${theme.name}"
           style="background: ${theme.chip}"
           onclick="vs.selectTheme('${key}')">
      </div>
    `).join('');
  },
  
  // üÜï Select theme via chip
  selectTheme(themeName) {
    document.getElementById('th').value = themeName;
    this.updateThemeChips(themeName);
    this.draw();
  },
  
  // üÜï Update theme chip active state
  updateThemeChips(activeTheme) {
    document.querySelectorAll('.theme-chip').forEach(chip => {
      chip.classList.toggle('active', chip.dataset.theme === activeTheme);
    });
  },
  
  // ============ INITIALIZATION ============
  async init() {
    this.ctx = this.can.getContext('2d');
    this.updateStatus('loading', '‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...');
    
    // Detect mobile
    this.checkMobile();
    window.addEventListener('resize', () => this.checkMobile());
    
    // Set today's date
    const today = new Date();
    document.getElementById('postDate').valueAsDate = today;
    this.updateDateDisplay();
    
    // Build Rashi Input List
    this.buildRashiList();
    
    // üÜï Build Theme Chips
    this.buildThemeChips();
    
    // Setup mobile menu
    this.setupMobileMenu();
    
    // Setup touch/swipe gestures
    this.setupTouchGestures();
    
    // Load QR Code Image
    this.updateStatus('loading', 'QR ‡§ï‡•ã‡§° ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...');
    await this.loadQRCode();
    
    // Wait for fonts
    this.updateStatus('loading', '‡§´‡•â‡§®‡•ç‡§ü‡•ç‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...');
    await this.waitForFonts();
    
    // Load saved data (including pandit preference)
    this.loadSavedData();
    
    // Initialize pandit info display
    this.onPanditChange();
    
    // Ready!
    this.isReady = true;
    this.updateStatus('ready', '‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‚úì');
    this.enableButtons();
    this.sync();
    
    // Keyboard shortcuts
    this.setupKeyboardShortcuts();
    
    // Auto-save to localStorage
    setInterval(() => this.saveData(), 30000);
    
    this.toast('Vedic Studio Pro v13 ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à!', 'success');
    
    // Show swipe hint on mobile (once)
    if (this.isMobile && !localStorage.getItem('swipeHintShown')) {
      setTimeout(() => {
        document.getElementById('swipeHint').style.display = 'block';
        localStorage.setItem('swipeHintShown', 'true');
      }, 1000);
    }
  },
  
  checkMobile() {
    this.isMobile = window.innerWidth <= 768;
  },
  
  // ============ MOBILE MENU ============
  setupMobileMenu() {
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    const toggleMenu = () => {
      const isOpen = sidebar.classList.toggle('open');
      menuToggle.classList.toggle('active', isOpen);
      overlay.classList.toggle('active', isOpen);
      document.body.style.overflow = isOpen ? 'hidden' : '';
    };
    
    const closeMenu = () => {
      sidebar.classList.remove('open');
      menuToggle.classList.remove('active');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    };
    
    menuToggle.addEventListener('click', toggleMenu);
    overlay.addEventListener('click', closeMenu);
    
    sidebar.querySelectorAll('select, .quick-btn, .btn').forEach(el => {
      el.addEventListener('change', () => {
        if (this.isMobile) setTimeout(closeMenu, 300);
      });
      el.addEventListener('click', () => {
        if (this.isMobile && el.classList.contains('btn')) {
          setTimeout(closeMenu, 300);
        }
      });
    });
  },
  
  // ============ TOUCH GESTURES ============
  setupTouchGestures() {
    const container = document.getElementById('canvasContainer');
    
    container.addEventListener('touchstart', (e) => {
      this.touchStartX = e.touches[0].clientX;
      this.touchStartY = e.touches[0].clientY;
    }, { passive: true });
    
    container.addEventListener('touchend', (e) => {
      if (!this.isMobile) return;
      
      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;
      const deltaX = touchEndX - this.touchStartX;
      const deltaY = touchEndY - this.touchStartY;
      
      if (Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY) * 1.5) {
        if (deltaX > 0) {
          this.slide(-1);
        } else {
          this.slide(1);
        }
        
        if (navigator.vibrate) {
          navigator.vibrate(10);
        }
      }
    }, { passive: true });
  },
  
  // Load QR Code from URL
  loadQRCode() {
    return new Promise((resolve) => {
      const pandit = this.getPandit();
      
      // üÜï Only load QR if pandit has QR enabled
      if (!pandit.hasQR || !pandit.qrUrl) {
        this.qrLoaded = false;
        resolve(false);
        return;
      }
      
      this.qrImage = new Image();
      this.qrImage.crossOrigin = 'anonymous';
      
      this.qrImage.onload = () => {
        this.qrLoaded = true;
        console.log('‚úÖ QR Code loaded successfully');
        resolve(true);
      };
      
      this.qrImage.onerror = (err) => {
        console.warn('‚ö†Ô∏è QR Code failed to load:', err);
        this.qrLoaded = false;
        resolve(false);
      };
      
      this.qrImage.src = pandit.qrUrl;
    });
  },
  
  buildRashiList() {
    const container = document.getElementById('rashiList');
    container.innerHTML = this.rashis.map((r, i) => `
      <div class="r-item">
        <div class="r-item-header">
          <label>${r.symbol} ${r.name}</label>
          <span>${r.en}</span>
        </div>
        <textarea 
          class="rashi-text" 
          data-index="${i}" 
          placeholder="${r.name} ‡§∞‡§æ‡§∂‡§ø ‡§ï‡§æ ‡§´‡§≤ ‡§≤‡§ø‡§ñ‡•á‡§Ç..."
          oninput="vs.onRashiInput(${i})"
        ></textarea>
      </div>
    `).join('');
  },
  
  async waitForFonts() {
    const fonts = [
      'bold 48px "Cinzel Decorative"',
      '400 32px "Noto Serif Devanagari"',
      '600 24px "Outfit"'
    ];
    
    try {
      await Promise.all(fonts.map(f => document.fonts.load(f)));
      return true;
    } catch (e) {
      console.warn('Font loading warning:', e);
      return false;
    }
  },
  
  setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        this.downloadPNG();
      }
      if (e.key === 'ArrowLeft') this.slide(-1);
      if (e.key === 'ArrowRight') this.slide(1);
      if (e.key === 'Escape') {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('menuToggle').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
      }
    });
  },
  
  // ============ UI HELPERS ============
  updateStatus(state, text) {
    document.getElementById('statusDot').className = `status-dot ${state}`;
    document.getElementById('statusText').textContent = text;
  },
  
  updateDateDisplay() {
    const dateInput = document.getElementById('postDate').value;
    const date = dateInput ? new Date(dateInput) : new Date();
    
    const days = ['‡§∞‡§µ‡§ø‡§µ‡§æ‡§∞', '‡§∏‡•ã‡§Æ‡§µ‡§æ‡§∞', '‡§Æ‡§Ç‡§ó‡§≤‡§µ‡§æ‡§∞', '‡§¨‡•Å‡§ß‡§µ‡§æ‡§∞', '‡§ó‡•Å‡§∞‡•Å‡§µ‡§æ‡§∞', '‡§∂‡•Å‡§ï‡•ç‡§∞‡§µ‡§æ‡§∞', '‡§∂‡§®‡§ø‡§µ‡§æ‡§∞'];
    const months = ['‡§ú‡§®‡§µ‡§∞‡•Ä', '‡§´‡§∞‡§µ‡§∞‡•Ä', '‡§Æ‡§æ‡§∞‡•ç‡§ö', '‡§Ö‡§™‡•ç‡§∞‡•à‡§≤', '‡§Æ‡§à', '‡§ú‡•Ç‡§®', '‡§ú‡•Å‡§≤‡§æ‡§à', '‡§Ö‡§ó‡§∏‡•ç‡§§', '‡§∏‡§ø‡§§‡§Ç‡§¨‡§∞', '‡§Ö‡§ï‡•ç‡§ü‡•Ç‡§¨‡§∞', '‡§®‡§µ‡§Ç‡§¨‡§∞', '‡§¶‡§ø‡§∏‡§Ç‡§¨‡§∞'];
    
    document.getElementById('todayDate').textContent = `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
    document.getElementById('todayDay').textContent = days[date.getDay()];
  },
  
  log(msg, type = '') {
    const el = document.getElementById('logArea');
    el.className = `log-area ${type}`;
    if (type === 'loading') {
      el.innerHTML = `<div class="spinner"></div> ${msg}`;
    } else {
      el.textContent = msg;
    }
  },
  
  toast(msg, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
      <span>${msg}</span>
    `;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  },
  
  setProgress(percent) {
    const container = document.getElementById('progressContainer');
    const bar = document.getElementById('progressBar');
    container.classList.toggle('active', percent > 0 && percent < 100);
    bar.style.width = `${percent}%`;
  },
  
  enableButtons() {
    document.querySelectorAll('.btn').forEach(b => b.disabled = false);
  },
  
  // ============ MODE SYNC ============
  sync() {
    const mode = document.getElementById('mode').value;
    const pandit = this.getPandit();
    
    document.getElementById('rashiBox').classList.toggle('hidden', mode !== 'rashi');
    document.getElementById('editBox').classList.toggle('hidden', mode === 'rashi');
    document.getElementById('navPanel').classList.toggle('hidden', mode !== 'rashi');
    
    const titles = {
      alert: 'üì¢ ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü',
      panchang: 'üìÖ ‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó ‡§µ‡§ø‡§µ‡§∞‡§£',
      letterhead: 'üìÑ ‡§™‡§§‡•ç‡§∞ ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü'
    };
    document.getElementById('editTitle').textContent = titles[mode] || '‚úèÔ∏è ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§è‡§°‡§ø‡§ü‡§∞';
    
    const defaults = {
      alert: { h: '‡§µ‡§ø‡§∂‡•á‡§∑ ‡§ó‡•ç‡§∞‡§π ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®', b: '‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ú‡•ç‡§Ø‡•ã‡§§‡§ø‡§∑‡•Ä‡§Ø ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•á‡§Ç...' },
      panchang: { h: '‡§Ü‡§ú ‡§ï‡§æ ‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó', b: '‡§§‡§ø‡§•‡§ø:\n‡§®‡§ï‡•ç‡§∑‡§§‡•ç‡§∞:\n‡§Ø‡•ã‡§ó:\n‡§ï‡§∞‡§£:\n‡§∞‡§æ‡§π‡•Å‡§ï‡§æ‡§≤:' },
      letterhead: { h: '‡•• ‡§∂‡•Å‡§≠‡§Æ‡•ç ‡§≠‡§µ‡§§‡•Å ‡••', b: `‡§Ü‡§¶‡§∞‡§£‡•Ä‡§Ø,\n\n‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§®‡§æ ‡§™‡§§‡•ç‡§∞ ‡§≤‡§ø‡§ñ‡•á‡§Ç...\n\n‡§≠‡§µ‡§¶‡•Ä‡§Ø,\n${pandit.name}` }
    };
    
    if (defaults[mode]) {
      document.getElementById('mainH').value = defaults[mode].h;
      document.getElementById('mainB').value = defaults[mode].b;
    }
    
    this.updateDateDisplay();
    this.draw();
  },
  
  // ============ NAVIGATION ============
  slide(dir) {
    const mode = document.getElementById('mode').value;
    if (mode !== 'rashi') return;
    
    this.currentIdx = (this.currentIdx + dir + 12) % 12;
    document.getElementById('navName').textContent = `${this.rashis[this.currentIdx].symbol} ${this.rashis[this.currentIdx].name}`;
    document.getElementById('navCount').textContent = `${this.currentIdx + 1} / 12`;
    this.draw();
  },
  
  onRashiInput(idx) {
    if (this.currentIdx !== idx) {
      this.currentIdx = idx;
      document.getElementById('navName').textContent = `${this.rashis[idx].symbol} ${this.rashis[idx].name}`;
      document.getElementById('navCount').textContent = `${idx + 1} / 12`;
    }
    this.draw();
  },
  
  // ============ QUICK ACTIONS ============
  clearAll() {
    document.querySelectorAll('.rashi-text').forEach(t => t.value = '');
    this.draw();
    this.toast('‡§∏‡§≠‡•Ä ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§Æ‡§ø‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ', 'info');
  },
  
  fillSample() {
    const samples = [
      '‡§Ü‡§ú ‡§ï‡§æ ‡§¶‡§ø‡§® ‡§∂‡•Å‡§≠ ‡§∞‡§π‡•á‡§ó‡§æ‡•§ ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§≤‡§æ‡§≠ ‡§ï‡•á ‡§Ø‡•ã‡§ó ‡§π‡•à‡§Ç‡•§ ‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§ñ‡•Å‡§∂‡•Ä ‡§ï‡§æ ‡§Æ‡§æ‡§π‡•å‡§≤ ‡§∞‡§π‡•á‡§ó‡§æ‡•§',
      '‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§Æ‡§æ‡§Æ‡§≤‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡•Ä ‡§∞‡§ñ‡•á‡§Ç‡•§ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§ï‡§æ ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§∞‡§ñ‡•á‡§Ç‡•§ ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§ü‡§æ‡§≤‡•á‡§Ç‡•§',
      '‡§®‡§è ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§â‡§§‡•ç‡§§‡§Æ ‡§¶‡§ø‡§®‡•§ ‡§Æ‡§ø‡§§‡•ç‡§∞‡•ã‡§Ç ‡§∏‡•á ‡§∏‡§π‡§Ø‡•ã‡§ó ‡§Æ‡§ø‡§≤‡•á‡§ó‡§æ‡•§',
      '‡§≠‡§æ‡§ó‡•ç‡§Ø ‡§∏‡§æ‡§• ‡§¶‡•á‡§ó‡§æ‡•§ ‡§®‡•å‡§ï‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§ï‡•á ‡§Ø‡•ã‡§ó‡•§ ‡§™‡•ç‡§∞‡•á‡§Æ ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§Æ‡§ß‡•Å‡§∞‡§§‡§æ‡•§',
      '‡§∏‡§Æ‡•ç‡§Æ‡§æ‡§® ‡§Æ‡•á‡§Ç ‡§µ‡•É‡§¶‡•ç‡§ß‡§ø ‡§π‡•ã‡§ó‡•Ä‡•§ ‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø‡§ï ‡§∏‡§´‡§≤‡§§‡§æ ‡§Æ‡§ø‡§≤‡•á‡§ó‡•Ä‡•§ ‡§Ü‡§§‡•ç‡§Æ‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§¨‡§¢‡§º‡•á‡§ó‡§æ‡•§',
      '‡§µ‡§ø‡§∏‡•ç‡§§‡§æ‡§∞ ‡§∏‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§õ‡•ã‡§ü‡•Ä-‡§õ‡•ã‡§ü‡•Ä ‡§¨‡§æ‡§§‡•ã‡§Ç ‡§™‡§∞ ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç‡•§ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§â‡§§‡•ç‡§§‡§Æ ‡§∞‡§π‡•á‡§ó‡§æ‡•§',
      '‡§∏‡§æ‡§ù‡•á‡§¶‡§æ‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§≤‡§æ‡§≠‡•§ ‡§µ‡§ø‡§µ‡§æ‡§π ‡§ï‡•á ‡§Ø‡•ã‡§ó‡•§ ‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä ‡§Æ‡§æ‡§Æ‡§≤‡•á ‡§∏‡•Å‡§≤‡§ù‡•á‡§Ç‡§ó‡•á‡•§',
      '‡§ó‡•Å‡§™‡•ç‡§§ ‡§∂‡§§‡•ç‡§∞‡•Å‡§ì‡§Ç ‡§∏‡•á ‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡•§ ‡§Ö‡§ö‡§æ‡§®‡§ï ‡§ß‡§® ‡§≤‡§æ‡§≠‡•§ ‡§∂‡•ã‡§ß ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§Æ‡•á‡§Ç ‡§∏‡§´‡§≤‡§§‡§æ‡•§',
      '‡§≠‡§æ‡§ó‡•ç‡§Ø‡•ã‡§¶‡§Ø ‡§ï‡§æ ‡§∏‡§Æ‡§Ø‡•§ ‡§ß‡§æ‡§∞‡•ç‡§Æ‡§ø‡§ï ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§ï‡•á ‡§Ø‡•ã‡§ó‡•§ ‡§ó‡•Å‡§∞‡•Å ‡§ï‡•É‡§™‡§æ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§π‡•ã‡§ó‡•Ä‡•§',
      '‡§ï‡§∞‡•ç‡§Æ ‡§Æ‡•á‡§Ç ‡§∏‡§´‡§≤‡§§‡§æ‡•§ ‡§™‡§¶‡•ã‡§®‡•ç‡§®‡§§‡§ø ‡§ï‡•á ‡§Ø‡•ã‡§ó‡•§ ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§™‡•ç‡§∞‡§§‡§ø‡§∑‡•ç‡§†‡§æ ‡§¨‡§¢‡§º‡•á‡§ó‡•Ä‡•§',
      '‡§Æ‡§ø‡§§‡•ç‡§∞‡•ã‡§Ç ‡§∏‡•á ‡§≤‡§æ‡§≠‡•§ ‡§Ü‡§Ø ‡§Æ‡•á‡§Ç ‡§µ‡•É‡§¶‡•ç‡§ß‡§ø‡•§ ‡§á‡§ö‡•ç‡§õ‡§æ‡§è‡§Ç ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§π‡•ã‡§Ç‡§ó‡•Ä‡•§',
      '‡§Ü‡§ß‡•ç‡§Ø‡§æ‡§§‡•ç‡§Æ‡§ø‡§ï ‡§â‡§®‡•ç‡§®‡§§‡§ø‡•§ ‡§µ‡•ç‡§Ø‡§Ø ‡§Ö‡§ß‡§ø‡§ï ‡§∞‡§π‡•á‡§ó‡§æ‡•§ ‡§µ‡§ø‡§¶‡•á‡§∂ ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§ï‡•á ‡§Ø‡•ã‡§ó‡•§'
    ];
    document.querySelectorAll('.rashi-text').forEach((t, i) => t.value = samples[i]);
    this.draw();
    this.toast('‡§∏‡•à‡§Ç‡§™‡§≤ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§≠‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ', 'success');
  },
  
  // ============ SAVE/LOAD DATA ============
  saveData() {
    const data = {
      pandit: this.currentPandit,
      mode: document.getElementById('mode').value,
      theme: document.getElementById('th').value,
      fontSize: document.getElementById('fs').value,
      rashiTexts: Array.from(document.querySelectorAll('.rashi-text')).map(t => t.value),
      mainH: document.getElementById('mainH').value,
      mainB: document.getElementById('mainB').value
    };
    localStorage.setItem('vedicStudioData', JSON.stringify(data));
  },
  
  loadSavedData() {
    try {
      const saved = localStorage.getItem('vedicStudioData');
      if (saved) {
        const data = JSON.parse(saved);
        
        if (data.pandit && this.pandits[data.pandit]) {
          this.currentPandit = data.pandit;
          document.getElementById('panditSelect').value = data.pandit;
        }
        
        document.getElementById('mode').value = data.mode || 'rashi';
        document.getElementById('th').value = data.theme || 'saumya';
        document.getElementById('fs').value = data.fontSize || 42;
        
        // Update theme chips
        this.updateThemeChips(data.theme || 'saumya');
        
        if (data.rashiTexts) {
          document.querySelectorAll('.rashi-text').forEach((t, i) => {
            t.value = data.rashiTexts[i] || '';
          });
        }
        
        document.getElementById('mainH').value = data.mainH || '';
        document.getElementById('mainB').value = data.mainB || '';
      }
    } catch (e) {
      console.warn('Could not load saved data:', e);
    }
  },
  
  // ============ MAIN DRAWING ENGINE ============
  draw(forceIndex = null) {
    const mode = document.getElementById('mode').value;
    const themeName = document.getElementById('th').value;
    const fontSize = parseInt(document.getElementById('fs').value);
    const theme = this.themes[themeName];
    const pandit = this.getPandit();
    
    document.getElementById('fv').textContent = `${fontSize}px`;
    
    // Canvas Size
    if (mode === 'letterhead') {
      this.can.width = 1240;
      this.can.height = 1754;
    } else {
      this.can.width = 1080;
      this.can.height = 1350;
    }
    
    const ctx = this.ctx;
    const W = this.can.width;
    const H = this.can.height;
    
    // üÜï Enhanced Background Gradient (supports multi-stop gradients)
    const bgGrad = ctx.createLinearGradient(0, 0, 0, H);
    if (theme.gradientStops && theme.bgGrad.length > 2) {
      theme.bgGrad.forEach((color, i) => {
        bgGrad.addColorStop(theme.gradientStops[i], color);
      });
    } else {
      bgGrad.addColorStop(0, theme.bgGrad[0]);
      bgGrad.addColorStop(1, theme.bgGrad[1]);
    }
    ctx.fillStyle = bgGrad;
    ctx.fillRect(0, 0, W, H);
    
    // üÜï Add subtle pattern overlay for premium themes
    if (['sandhya', 'samudra', 'vaibhav'].includes(themeName)) {
      this.drawPatternOverlay(ctx, W, H, theme);
    }
    
    // Decorative Corner Patterns
    this.drawCornerPatterns(ctx, W, H, theme);
    
    // Main Border
    this.drawBorder(ctx, W, H, theme);
    
    // Mode-specific content
    if (mode === 'letterhead') {
      this.drawLetterhead(ctx, W, H, theme, fontSize, pandit);
    } else if (mode === 'rashi') {
      const idx = forceIndex !== null ? forceIndex : this.currentIdx;
      this.drawRashifal(ctx, W, H, theme, fontSize, idx, pandit);
    } else {
      this.drawSinglePost(ctx, W, H, theme, fontSize, mode, pandit);
    }
    
    // Footer
    this.drawFooter(ctx, W, H, theme, mode, pandit);
  },
  
  // üÜï Pattern overlay for premium themes
  drawPatternOverlay(ctx, W, H, theme) {
    ctx.save();
    ctx.globalAlpha = 0.03;
    
    // Draw subtle mandala-like pattern
    const centerX = W / 2;
    const centerY = H / 2;
    
    for (let i = 0; i < 8; i++) {
      ctx.beginPath();
      ctx.arc(centerX, centerY, 200 + i * 100, 0, Math.PI * 2);
      ctx.strokeStyle = theme.acc;
      ctx.lineWidth = 1;
      ctx.stroke();
    }
    
    ctx.restore();
  },
  
  drawCornerPatterns(ctx, W, H, theme) {
    ctx.strokeStyle = theme.acc + '30';
    ctx.lineWidth = 2;
    
    const corners = [[30, 30], [W-30, 30], [30, H-30], [W-30, H-30]];
    corners.forEach(([x, y], i) => {
      ctx.beginPath();
      const sx = i % 2 === 0 ? 1 : -1;
      const sy = i < 2 ? 1 : -1;
      ctx.moveTo(x, y + sy * 40);
      ctx.lineTo(x, y);
      ctx.lineTo(x + sx * 40, y);
      ctx.stroke();
      
      // Add decorative dot
      ctx.beginPath();
      ctx.arc(x + sx * 8, y + sy * 8, 4, 0, Math.PI * 2);
      ctx.fillStyle = theme.acc;
      ctx.fill();
      
      // üÜï Add extra flourish
      ctx.beginPath();
      ctx.arc(x + sx * 20, y + sy * 20, 2, 0, Math.PI * 2);
      ctx.fill();
    });
  },
  
  drawBorder(ctx, W, H, theme) {
    // Outer border
    ctx.strokeStyle = theme.bdr;
    ctx.lineWidth = 4;
    ctx.strokeRect(25, 25, W-50, H-50);
    
    // Inner decorative border
    ctx.strokeStyle = theme.acc;
    ctx.lineWidth = 1;
    ctx.setLineDash([10, 5]);
    ctx.strokeRect(40, 40, W-80, H-80);
    ctx.setLineDash([]);
    
    // Bold inner frame
    ctx.lineWidth = 8;
    ctx.strokeStyle = theme.acc + '40';
    ctx.strokeRect(55, 55, W-110, H-110);
    
    // üÜï Extra decorative line
    ctx.lineWidth = 1;
    ctx.strokeStyle = theme.acc + '20';
    ctx.strokeRect(65, 65, W-130, H-130);
  },
  
  // üÜï FIXED: Letterhead with proper text wrapping
  drawLetterhead(ctx, W, H, theme, fontSize, pandit) {
    // Header section
    ctx.fillStyle = theme.footer;
    ctx.fillRect(60, 60, W-120, 220);
    
    this.drawLogo(ctx, 80, 90, 160, theme);
    
    ctx.textAlign = 'left';
    ctx.fillStyle = theme.acc;
    ctx.font = 'bold 52px "Cinzel Decorative"';
    ctx.fillText(pandit.name, 260, 145);
    
    ctx.fillStyle = theme.txt;
    ctx.font = '600 24px "Outfit"';
    ctx.fillText(pandit.title, 260, 190);
    ctx.font = '400 20px "Outfit"';
    ctx.fillText(`${pandit.addressDisplay} | ‚òé ${pandit.phone}`, 260, 225);
    
    // Divider line
    ctx.strokeStyle = theme.acc;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(80, 300);
    ctx.lineTo(W-80, 300);
    ctx.stroke();
    
    // Decorative element
    ctx.beginPath();
    ctx.arc(W/2, 300, 8, 0, Math.PI * 2);
    ctx.fillStyle = theme.acc;
    ctx.fill();
    
    const heading = document.getElementById('mainH').value || '‡•• ‡§∂‡•Å‡§≠‡§Æ‡•ç ‡§≠‡§µ‡§§‡•Å ‡••';
    const body = document.getElementById('mainB').value || '';
    
    // Heading
    ctx.textAlign = 'center';
    ctx.fillStyle = theme.acc;
    ctx.font = 'bold 40px "Cinzel Decorative"';
    ctx.fillText(heading, W/2, 370);
    
    // üÜï FIXED: Body text with proper wrapping and page boundaries
    ctx.textAlign = 'left';
    ctx.fillStyle = theme.txt;
    ctx.font = `${fontSize}px "Noto Serif Devanagari"`;
    
    const marginX = 100;
    const marginTop = 440;
    const maxWidth = W - (marginX * 2);
    const lineHeight = fontSize * 1.6;
    const maxY = H - 250; // Leave space for footer
    
    this.wrapTextWithLimit(ctx, body, marginX, marginTop, maxWidth, lineHeight, maxY);
  },
  
  drawRashifal(ctx, W, H, theme, fontSize, idx, pandit) {
    const rashi = this.rashis[idx];
    const textareas = document.querySelectorAll('.rashi-text');
    const content = textareas[idx]?.value || '‡§∞‡§æ‡§∂‡§ø‡§´‡§≤ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ...';
    
    ctx.fillStyle = theme.footer;
    ctx.fillRect(55, 55, W-110, 180);
    
    this.drawLogo(ctx, 80, 75, 140, theme);
    
    ctx.textAlign = 'left';
    ctx.fillStyle = theme.acc;
    ctx.font = 'bold 44px "Cinzel Decorative"';
    ctx.fillText(pandit.name, 240, 138);
    ctx.font = '400 20px "Outfit"';
    ctx.fillStyle = theme.txt;
    ctx.fillText(`${pandit.titleShort} | ${pandit.handleDisplay}`, 240, 175);
    
    const dateInput = document.getElementById('postDate').value;
    const date = dateInput ? new Date(dateInput) : new Date();
    const dateStr = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
    ctx.textAlign = 'right';
    ctx.font = 'bold 26px "Outfit"';
    ctx.fillStyle = theme.acc;
    ctx.fillText(dateStr, W-80, 125);
    ctx.font = '400 18px "Outfit"';
    ctx.fillText('‡§¶‡•à‡§®‡§ø‡§ï ‡§∞‡§æ‡§∂‡§ø‡§´‡§≤', W-80, 155);
    
    ctx.textAlign = 'center';
    
    // Rashi symbol circle
    ctx.beginPath();
    ctx.arc(W/2, 355, 75, 0, Math.PI * 2);
    ctx.fillStyle = theme.acc + '20';
    ctx.fill();
    ctx.strokeStyle = theme.acc;
    ctx.lineWidth = 3;
    ctx.stroke();
    
    // Inner circle
    ctx.beginPath();
    ctx.arc(W/2, 355, 60, 0, Math.PI * 2);
    ctx.strokeStyle = theme.acc + '40';
    ctx.lineWidth = 1;
    ctx.stroke();
    
    ctx.font = '90px serif';
    ctx.fillStyle = theme.acc;
    ctx.fillText(rashi.symbol, W/2, 385);
    
    ctx.font = 'bold 68px "Cinzel Decorative"';
    ctx.fillText(rashi.name, W/2, 510);
    
    ctx.font = '600 26px "Outfit"';
    ctx.fillStyle = theme.txt + '80';
    ctx.fillText(rashi.en, W/2, 555);
    
    // Rashifal content
    ctx.textAlign = 'center';
    ctx.fillStyle = theme.txt;
    ctx.font = `${fontSize}px "Noto Serif Devanagari"`;
    
    const maxY = H - 220;
    this.wrapTextWithLimit(ctx, content, W/2, 640, W-180, fontSize * 1.7, maxY, 'center');
  },
  
  drawSinglePost(ctx, W, H, theme, fontSize, mode, pandit) {
    const heading = document.getElementById('mainH').value || '‡§∂‡•Ä‡§∞‡•ç‡§∑‡§ï';
    const body = document.getElementById('mainB').value || '‡§µ‡§ø‡§µ‡§∞‡§£ ‡§Ø‡§π‡§æ‡§Å...';
    
    ctx.fillStyle = theme.footer;
    ctx.fillRect(55, 55, W-110, 180);
    
    this.drawLogo(ctx, 80, 75, 140, theme);
    
    ctx.textAlign = 'left';
    ctx.fillStyle = theme.acc;
    ctx.font = 'bold 44px "Cinzel Decorative"';
    ctx.fillText(pandit.name, 240, 138);
    ctx.font = '400 20px "Outfit"';
    ctx.fillStyle = theme.txt;
    ctx.fillText(`${pandit.titleShort} | ${pandit.handleDisplay}`, 240, 175);
    
    const badges = {
      alert: { text: 'üì¢ ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∏‡•Ç‡§ö‡§®‡§æ', color: '#dc2626' },
      panchang: { text: 'üìÖ ‡§¶‡•à‡§®‡§ø‡§ï ‡§™‡§Ç‡§ö‡§æ‡§Ç‡§ó', color: '#0891b2' }
    };
    const badge = badges[mode] || { text: 'üìå Update', color: theme.acc };
    
    ctx.textAlign = 'right';
    ctx.font = 'bold 22px "Outfit"';
    ctx.fillStyle = badge.color;
    ctx.fillText(badge.text, W-80, 135);
    
    // Heading
    ctx.textAlign = 'center';
    ctx.fillStyle = theme.acc;
    ctx.font = 'bold 56px "Cinzel Decorative"';
    this.wrapTextWithLimit(ctx, heading, W/2, 350, W-150, 70, 450, 'center');
    
    // Body
    ctx.fillStyle = theme.txt;
    ctx.font = `${fontSize}px "Noto Serif Devanagari"`;
    const maxY = H - 220;
    this.wrapTextWithLimit(ctx, body, W/2, 480, W-160, fontSize * 1.7, maxY, 'center');
  },
  
  // üÜï UPDATED: Footer with conditional QR code
  drawFooter(ctx, W, H, theme, mode, pandit) {
    const footerY = H - 200;
    
    ctx.fillStyle = theme.footer;
    ctx.fillRect(55, footerY, W-110, 145);
    
    // üÜï Only show QR for pandits with hasQR = true
    let textStartX = 85;
    if (pandit.hasQR && this.qrLoaded) {
      this.drawQR(ctx, 85, footerY + 20, 105, theme);
      textStartX = 210;
    } else {
      // Draw decorative element instead of QR
      this.drawDecorativeElement(ctx, 85, footerY + 20, 105, theme);
      textStartX = 210;
    }
    
    ctx.textAlign = 'left';
    ctx.fillStyle = theme.acc;
    ctx.font = 'bold 30px "Cinzel Decorative"';
    ctx.fillText(pandit.name, textStartX, footerY + 52);
    
    ctx.fillStyle = theme.txt;
    ctx.font = '400 20px "Outfit"';
    ctx.fillText(pandit.phoneDisplay, textStartX, footerY + 85);
    
    if (pandit.website) {
      ctx.fillText(pandit.websiteDisplay, textStartX, footerY + 115);
    } else {
      const addressText = pandit.addressShort ? `üìç ${pandit.addressShort}` : pandit.addressDisplay;
      ctx.fillText(addressText, textStartX, footerY + 115);
    }
    
    ctx.textAlign = 'right';
    ctx.font = '400 18px "Outfit"';
    ctx.fillStyle = theme.txt + 'aa';
    ctx.fillText(pandit.socials, W-85, footerY + 85);
    ctx.fillText(pandit.handle || pandit.addressShort || '', W-85, footerY + 115);
  },
  
  // üÜï Decorative element for when QR is not available
  drawDecorativeElement(ctx, x, y, size, theme) {
    ctx.save();
    
    // Decorative mandala-like pattern
    const centerX = x + size/2;
    const centerY = y + size/2;
    
    // Outer circle
    ctx.beginPath();
    ctx.arc(centerX, centerY, size/2 - 5, 0, Math.PI * 2);
    ctx.fillStyle = theme.acc + '20';
    ctx.fill();
    ctx.strokeStyle = theme.acc;
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Inner circles
    ctx.beginPath();
    ctx.arc(centerX, centerY, size/3, 0, Math.PI * 2);
    ctx.stroke();
    
    ctx.beginPath();
    ctx.arc(centerX, centerY, size/5, 0, Math.PI * 2);
    ctx.fillStyle = theme.acc;
    ctx.fill();
    
    // Om symbol
    ctx.font = `${size * 0.4}px serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = theme.acc;
    ctx.fillText('üôè', centerX, centerY);
    
    ctx.restore();
  },
  
  drawLogo(ctx, x, y, size, theme) {
    ctx.save();
    
    ctx.beginPath();
    ctx.arc(x + size/2, y + size/2, size/2 - 5, 0, Math.PI * 2);
    ctx.fillStyle = theme.acc + '20';
    ctx.fill();
    ctx.strokeStyle = theme.acc;
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Inner ring
    ctx.beginPath();
    ctx.arc(x + size/2, y + size/2, size/2 - 15, 0, Math.PI * 2);
    ctx.strokeStyle = theme.acc + '50';
    ctx.lineWidth = 1;
    ctx.stroke();
    
    ctx.font = `${size * 0.5}px serif`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = theme.acc;
    ctx.fillText('üïâÔ∏è', x + size/2, y + size/2);
    
    ctx.restore();
  },
  
  drawQR(ctx, x, y, size, theme) {
    const pandit = this.getPandit();
    
    // üÜï Check if pandit has QR enabled
    if (!pandit.hasQR) {
      this.drawDecorativeElement(ctx, x, y, size, theme);
      return;
    }
    
    if (this.qrLoaded && this.qrImage) {
      try {
        ctx.fillStyle = '#fff';
        ctx.fillRect(x, y, size, size);
        ctx.drawImage(this.qrImage, x, y, size, size);
        ctx.strokeStyle = theme.acc;
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, size, size);
      } catch (err) {
        console.warn('Error drawing QR image, using fallback:', err);
        this.drawQRFallback(ctx, x, y, size, theme);
      }
    } else {
      this.drawQRFallback(ctx, x, y, size, theme);
    }
  },
  
  drawQRFallback(ctx, x, y, size, theme) {
    ctx.fillStyle = '#fff';
    ctx.fillRect(x, y, size, size);
    
    ctx.strokeStyle = theme.acc;
    ctx.lineWidth = 2;
    ctx.strokeRect(x, y, size, size);
    
    ctx.fillStyle = '#000';
    const cellSize = size / 10;
    const pattern = [
      [1,1,1,0,1,0,1,1,1,0],
      [1,0,1,0,0,1,1,0,1,0],
      [1,1,1,0,1,1,1,1,1,0],
      [0,0,0,0,1,0,0,0,0,0],
      [1,0,1,1,0,1,0,1,1,1],
      [0,1,0,0,1,0,1,0,0,1],
      [1,1,1,0,1,1,0,1,1,1],
      [1,0,1,0,0,0,0,1,0,1],
      [1,1,1,0,1,0,1,1,1,0],
      [0,0,0,0,1,0,0,0,0,0]
    ];
    
    pattern.forEach((row, i) => {
      row.forEach((cell, j) => {
        if (cell) {
          ctx.fillRect(x + j * cellSize, y + i * cellSize, cellSize - 1, cellSize - 1);
        }
      });
    });
  },
  
  // Original wrapText function
  wrapText(ctx, text, x, y, maxWidth, lineHeight, align = 'left') {
    ctx.textAlign = align;
    const paragraphs = text.split('\n');
    let currentY = y;
    
    paragraphs.forEach(para => {
      if (para.trim() === '') {
        currentY += lineHeight * 0.5;
        return;
      }
      
      const words = para.split(' ');
      let line = '';
      
      words.forEach((word, i) => {
        const testLine = line + word + ' ';
        const metrics = ctx.measureText(testLine);
        
        if (metrics.width > maxWidth && i > 0) {
          ctx.fillText(line.trim(), x, currentY);
          line = word + ' ';
          currentY += lineHeight;
        } else {
          line = testLine;
        }
      });
      
      ctx.fillText(line.trim(), x, currentY);
      currentY += lineHeight;
    });
    
    return currentY;
  },
  
  // üÜï NEW: Enhanced wrapText with Y limit (prevents overflow)
  wrapTextWithLimit(ctx, text, x, y, maxWidth, lineHeight, maxY, align = 'left') {
    ctx.textAlign = align;
    const paragraphs = text.split('\n');
    let currentY = y;
    let stopped = false;
    
    for (let p = 0; p < paragraphs.length && !stopped; p++) {
      const para = paragraphs[p];
      
      if (para.trim() === '') {
        currentY += lineHeight * 0.5;
        if (currentY > maxY) {
          stopped = true;
          break;
        }
        continue;
      }
      
      // Split by spaces but also handle Hindi text without spaces
      let words = para.split(' ');
      
      // If no spaces found, try to break by character clusters
      if (words.length === 1 && para.length > 20) {
        words = this.breakLongText(para, ctx, maxWidth);
      }
      
      let line = '';
      
      for (let i = 0; i < words.length && !stopped; i++) {
        const word = words[i];
        const testLine = line + word + ' ';
        const metrics = ctx.measureText(testLine);
        
        if (metrics.width > maxWidth && i > 0) {
          // Check if we're about to exceed Y limit
          if (currentY > maxY) {
            // Add ellipsis and stop
            ctx.fillText(line.trim() + '...', x, currentY);
            stopped = true;
            break;
          }
          
          ctx.fillText(line.trim(), x, currentY);
          line = word + ' ';
          currentY += lineHeight;
        } else {
          line = testLine;
        }
      }
      
      if (!stopped && line.trim()) {
        if (currentY > maxY) {
          ctx.fillText(line.trim() + '...', x, currentY);
          stopped = true;
        } else {
          ctx.fillText(line.trim(), x, currentY);
          currentY += lineHeight;
        }
      }
    }
    
    return currentY;
  },
  
  // üÜï Break long text without spaces into smaller chunks
  breakLongText(text, ctx, maxWidth) {
    const chunks = [];
    let current = '';
    
    for (let i = 0; i < text.length; i++) {
      const char = text[i];
      const testStr = current + char;
      
      if (ctx.measureText(testStr).width > maxWidth * 0.9) {
        chunks.push(current);
        current = char;
      } else {
        current = testStr;
      }
    }
    
    if (current) {
      chunks.push(current);
    }
    
    return chunks;
  },
  
  // ============ DOWNLOAD FUNCTIONS ============
  
  async downloadPNG() {
    if (!this.isReady) return;
    
    this.log('PNG ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§∞‡§π‡§æ...', 'loading');
    this.setProgress(30);
    
    try {
      await this.delay(100);
      this.draw();
      this.setProgress(60);
      
      const blob = await this.canvasToBlob();
      this.setProgress(90);
      
      const mode = document.getElementById('mode').value;
      const pandit = this.getPandit();
      let filename = `${pandit.nameShort}_${mode}`;
      
      if (mode === 'rashi') {
        filename = `${pandit.nameShort}_${this.currentIdx + 1}_${this.rashis[this.currentIdx].name}_${this.rashis[this.currentIdx].en}`;
      }
      
      filename += `_${Date.now()}.png`;
      
      this.downloadBlob(blob, filename);
      this.setProgress(100);
      
      await this.delay(300);
      this.setProgress(0);
      this.log('‚úÖ PNG ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§∏‡§´‡§≤!', 'success');
      this.toast('PNG ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ!', 'success');
      
    } catch (err) {
      console.error('PNG Error:', err);
      this.setProgress(0);
      this.log('‚ùå Error: ' + err.message, 'error');
      this.toast('‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§´‡•á‡§≤ ‡§π‡•Å‡§Ü', 'error');
    }
  },
  
  async downloadZIP() {
    if (!this.isReady) return;
    
    const textareas = document.querySelectorAll('.rashi-text');
    const filledCount = Array.from(textareas).filter(t => t.value.trim()).length;
    
    if (filledCount === 0) {
      this.toast('‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§∞‡§æ‡§∂‡§ø ‡§Æ‡•á‡§Ç ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§≤‡§ø‡§ñ‡•á‡§Ç!', 'error');
      return;
    }
    
    this.log(`üì¶ ${filledCount} ‡§á‡§Æ‡•á‡§ú ‡§¨‡§® ‡§∞‡§π‡•Ä ‡§π‡•à‡§Ç...`, 'loading');
    
    try {
      const zip = new JSZip();
      const pandit = this.getPandit();
      const folder = zip.folder(`${pandit.nameShort}_Rashifal`);
      let processed = 0;
      
      for (let i = 0; i < 12; i++) {
        if (textareas[i].value.trim()) {
          this.draw(i);
          await this.delay(50);
          
          const blob = await this.canvasToBlob();
          const filename = `${String(i + 1).padStart(2, '0')}_${this.rashis[i].name}_${this.rashis[i].en}.png`;
          folder.file(filename, blob);
          
          processed++;
          this.setProgress((processed / filledCount) * 80);
          this.log(`‚úì ${this.rashis[i].name} (${processed}/${filledCount})`, 'loading');
        }
      }
      
      this.log('ZIP ‡§¨‡§® ‡§∞‡§π‡•Ä ‡§π‡•à...', 'loading');
      this.setProgress(90);
      
      const zipBlob = await zip.generateAsync({ 
        type: 'blob',
        compression: 'DEFLATE',
        compressionOptions: { level: 6 }
      });
      
      const dateStr = new Date().toISOString().split('T')[0];
      this.downloadBlob(zipBlob, `${pandit.nameShort}_Rashifal_${dateStr}.zip`);
      
      this.setProgress(100);
      await this.delay(300);
      this.setProgress(0);
      
      this.draw();
      
      this.log(`‚úÖ ${filledCount} ‡§á‡§Æ‡•á‡§ú ZIP ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°!`, 'success');
      this.toast(`${filledCount} ‡§∞‡§æ‡§∂‡§ø‡§´‡§≤ ‡§á‡§Æ‡•á‡§ú ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•Å‡§à‡§Ç!`, 'success');
      
    } catch (err) {
      console.error('ZIP Error:', err);
      this.setProgress(0);
      this.log('‚ùå ZIP Error: ' + err.message, 'error');
      this.toast('ZIP ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç error', 'error');
    }
  },
  
  async downloadPDF() {
    if (!this.isReady) return;
    
    const mode = document.getElementById('mode').value;
    const pandit = this.getPandit();
    this.log('PDF ‡§¨‡§® ‡§∞‡§π‡•Ä ‡§π‡•à...', 'loading');
    this.setProgress(20);
    
    try {
      const { jsPDF } = window.jspdf;
      
      if (mode === 'rashi') {
        const textareas = document.querySelectorAll('.rashi-text');
        const filledIndices = [];
        textareas.forEach((t, i) => {
          if (t.value.trim()) filledIndices.push(i);
        });
        
        if (filledIndices.length === 0) {
          this.toast('‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§∞‡§æ‡§∂‡§ø ‡§Æ‡•á‡§Ç ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§≤‡§ø‡§ñ‡•á‡§Ç!', 'error');
          this.setProgress(0);
          return;
        }
        
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });
        
        for (let i = 0; i < filledIndices.length; i++) {
          const idx = filledIndices[i];
          this.draw(idx);
          await this.delay(100);
          
          const imgData = this.can.toDataURL('image/jpeg', 0.95);
          
          if (i > 0) pdf.addPage();
          
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          const imgRatio = this.can.width / this.can.height;
          
          let imgWidth = pageWidth - 20;
          let imgHeight = imgWidth / imgRatio;
          
          if (imgHeight > pageHeight - 20) {
            imgHeight = pageHeight - 20;
            imgWidth = imgHeight * imgRatio;
          }
          
          const x = (pageWidth - imgWidth) / 2;
          const y = (pageHeight - imgHeight) / 2;
          
          pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
          
          this.setProgress(20 + ((i + 1) / filledIndices.length) * 70);
          this.log(`PDF ‡§™‡•á‡§ú ${i + 1}/${filledIndices.length}...`, 'loading');
        }
        
        const dateStr = new Date().toISOString().split('T')[0];
        pdf.save(`${pandit.nameShort}_Rashifal_${dateStr}.pdf`);
        
        this.draw();
        
      } else {
        this.draw();
        await this.delay(100);
        
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });
        
        const imgData = this.can.toDataURL('image/jpeg', 0.95);
        
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const imgRatio = this.can.width / this.can.height;
        
        let imgWidth = pageWidth - 20;
        let imgHeight = imgWidth / imgRatio;
        
        if (imgHeight > pageHeight - 20) {
          imgHeight = pageHeight - 20;
          imgWidth = imgHeight * imgRatio;
        }
        
        const x = (pageWidth - imgWidth) / 2;
        const y = (pageHeight - imgHeight) / 2;
        
        pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
        pdf.save(`${pandit.nameShort}_${mode}_${Date.now()}.pdf`);
      }
      
      this.setProgress(100);
      await this.delay(300);
      this.setProgress(0);
      this.log('‚úÖ PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§∏‡§´‡§≤!', 'success');
      this.toast('PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§à!', 'success');
      
    } catch (err) {
      console.error('PDF Error:', err);
      this.setProgress(0);
      this.log('‚ùå PDF Error: ' + err.message, 'error');
      this.toast('PDF ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç error', 'error');
    }
  },
  
  async copyToClipboard() {
    if (!this.isReady) return;
    
    this.log('‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§Æ‡•á‡§Ç ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§∞‡§π‡§æ...', 'loading');
    
    try {
      this.draw();
      await this.delay(100);
      
      const blob = await this.canvasToBlob();
      
      await navigator.clipboard.write([
        new ClipboardItem({ 'image/png': blob })
      ]);
      
      this.log('‚úÖ ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§Æ‡•á‡§Ç ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ!', 'success');
      this.toast('‡§á‡§Æ‡•á‡§ú ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§à! ‡§Ö‡§¨ Paste ‡§ï‡§∞‡•á‡§Ç', 'success');
      
    } catch (err) {
      console.error('Clipboard Error:', err);
      this.log('‚ùå Clipboard not supported', 'error');
      this.toast('Clipboard access denied', 'error');
    }
  },
  
  // ============ UTILITY FUNCTIONS ============
  
  canvasToBlob() {
    return new Promise((resolve, reject) => {
      try {
        this.can.toBlob(blob => {
          if (blob) {
            resolve(blob);
          } else {
            reject(new Error('Canvas toBlob returned null'));
          }
        }, 'image/png', 1.0);
      } catch (err) {
        reject(err);
      }
    });
  },
  
  downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 1000);
  },
  
  delay(ms) {
    return new Promise(r => setTimeout(r, ms));
  }
};

// Initialize on load
window.addEventListener('load', () => vs.init());
</script>

</body>
</html>
